+++
date = "2017-07-23T07:00:00"
title = "世界上最痛苦的事情是，下載進度：99%，下載速度：3k/s、2k/s……"
titleimage = "https://pic1.zhimg.com/v2-99c631a661dc923e1b29d01d7cf4010c.jpg"
ga = 072307
+++

<div class="main-wrap content-wrap">
<div class="headline">

<div class="img-place-holder"></div>



</div>

<div class="content-inner">




<div class="question">
<h2 class="question-title">爲什麼有時候下載東西一開始很快，後來就越來越慢？</h2>

<div class="answer">



<div class="content">
<p>如果大家親自搭建 FTP 服務器做過實驗，就會發現，哪怕下一個 100G 的大文件，整個下載過程都是非常平穩的：除了最開始速率略慢、但 1 秒不到就到了網速上限然後一直保持，直到文件全部下載完畢，沒有任何波動。</p>
<p>但是&hellip;&hellip;網上到別人的服務器下載文件可不是這樣啊？</p>
<p>無論如何，我們已經通過實驗證明了，TCP/FTP 協議本身沒有問題。那麼我們就不需要繼續在上面浪費時間了。</p>
<p>那麼，問題在哪呢？</p>
<p>1、很多朋友談到&ldquo;多線程下載&rdquo;了。尤其對 P2P 下載，這的確是一個重要影響因素。</p>
<p>這是因爲，前面提到過，TCP 擁塞算法要保證&ldquo;每個鏈路公平分享帶寬&rdquo;&mdash;&mdash;嗯，如果一共 10M 帶寬，我和張三等十人每人一條鏈接 FTP 下載，那麼每人都能達到 1M 的下載速率，很公平，對吧？</p>
<p>但，如果張三耍流氓，他多開了一條鏈接呢？</p>
<p>現在成了每條鏈接 0.9M 帶寬，仍然很公平，對吧？</p>
<p>&hellip;&hellip;當然不對！</p>
<p>張三是兩條鏈接，他有 1.8M 的下載速率；而其它 9 人每人只有 1 條鏈接，所以只有 0.9M 的帶寬。</p>
<p>怎麼辦？多開鏈接唄。你敢開三條，我就開四條&hellip;&hellip;你開 200 條，我開 400 條&hellip;&hellip;誰開的多誰搶到的帶寬就越多，傻子纔不開。</p>
<p>（網管：現在你們明白爲啥要禁 P2P 了吧）</p>
<p>（服務提供商也不幹了：每條鏈接都得有個接受 / 發送緩衝區，這可都是內存啊。你們這麼整，我服務器還不得累死。不行，我得配置個策略，每個用戶 /IP 至多隻準建立一條鏈接[實際一般爲 1~5 條]，多了就強制斷開，反覆重試我 ban 你 IP）</p>
<p>（舉例只是類似宿舍共用路由的情形；實際上網絡任何部分都可能出現瓶頸。但一般來說，瓶頸多出現在末端）</p>
<p>下載一個文件時，只剩最後一點點了，多開鏈接就不划算了&mdash;&mdash;還沒跑滿帶寬就搬回來了，開越多反而更慢，還討人厭&hellip;&hellip;所以多線程下載到最後只剩 1 條鏈接，速度自然就慢了。</p>
<p>但，如果僅僅是爭搶帶寬的話&hellip;&hellip;經常 P2P 下載單鏈接也能跑到 400K 啊；爲什麼只剩一點點時，速度總是隻剩 2~3K？</p>
<p>這是因爲：</p>
<p>2、資源提供者的心機</p>
<p>我們知道，P2P 號稱&ldquo;下載者越多速度越快&rdquo;；原理很簡單，程序會自動讓每個人把自己下載到的部分分享出去，下載的人越多，分享者自然也越多，速度當然就越快了。</p>
<p>但現實中，有些人只下載不上傳（這種行爲被形象的稱爲&ldquo;吸血&rdquo;）；同時，多數用戶的下載帶寬和上傳帶寬不對等（說的就是你，ADSL；其實現在的光纖寬帶，一般也多是下載帶寬幾倍於上傳帶寬）；最後，多數人夜裏掛 P2P 軟件，並且會設置&ldquo;下載結束後關機&rdquo;。</p>
<p>這就導致下載量總是遠大於上傳量&mdash;&mdash;這麼一來，&ldquo;人越多反而越快&rdquo;就成了一句空話，玩不起來了。</p>
<p>怎麼辦？</p>
<p>檢查誰快下載完了，限他的速，讓他多做會兒種。</p>
<p>類似的，普通的下載站，他們當然希望吸引更多用戶；怎麼吸引呢？豐富的內容 + 更高的下載速度。</p>
<p>但，想提供更高的下載速度，就必須購買更多的帶寬&hellip;&hellip;可買帶寬是需要錢錢的&hellip;&hellip;</p>
<p>怎麼辦？</p>
<p>當同時下載量太大時，發現一個用戶剛開始下載，就給他一個更高的限速，允許他&ldquo;光速下載&rdquo;；下載一段時間後再限速&mdash;&mdash;用戶沒耐心一直盯着看，剛開始速度快讓他很高興，中後期他不看了就降速節約帶寬：這就解決了&ldquo;更快的下載速度&rdquo;和&ldquo;帶寬得花錢買&rdquo;之間的矛盾。</p>
<p>於是，買下和競爭對手一樣多的帶寬，用戶就是感覺我更快！</p>
<p>&nbsp;</p>
<p>最後，很多人可能會奇怪：下載到最後一點點，速度總是很慢；我暫停 / 斷開一小會兒，重新開始時下載速度就會很快，然後很快又降低到原來的程度了，這是爲什麼？</p>
<p>不，這可不是因爲高票那個一本道答案的&ldquo;慢起動&rdquo;。</p>
<p>要說清這個，咱得從限速算法的原理說起。</p>
<p>具體細節太複雜了；簡而言之，爲了滿足各種刁鑽古怪的要求，限速算法的原理並不是直接限制網絡傳輸速度（沒法實現），而是&ldquo;你想傳出去每一個字節的數據，都得得到我的授權；而&lsquo;授權令&rsquo;的產生速度很容易控制；那麼如果我每秒只產生 1M 個授權令，你的傳輸速率自然最高只有 1M/s；&lsquo;授權令&rsquo;可累積，但有上限&rdquo;。</p>
<p>&ldquo;授權令&ldquo;用術語說就叫&rdquo;桶&ldquo;。如果每個桶容量是 1K 字節，那麼我每秒產生 10 個桶，你的傳輸速率就只有 10K；我每秒產生 1000 個桶，你的傳輸速率就是 1M；但每個用戶最多隻能積攢 500 個桶，多了不用，我就認爲你沒數據要傳，更多的授權自然過期作廢。</p>
<p>明白了這個，問題就很容易解答了：下載到最後速度很慢是因爲限速，桶產生的太慢，產生一個你用一個，傳輸速率自然就被限到幾 K 了；暫停 / 斷開後，桶就給你累計下來，那麼恢復傳輸後，你就可以一次性把積攢下來的桶給用完&mdash;&mdash;於是瞬時傳輸速度就飆到了幾百 K 甚至若干 M；一旦桶用完了，傳輸速率自然又回到了幾 K&hellip;&hellip;</p>
<p>你以爲自己得了實惠&hellip;&hellip;實際上，瞬時幾百 K 的速度用的還是暫停時本就該分給你的桶；反倒是，因爲暫停 / 斷開時間過長，你還因爲溢出而浪費了很多桶&hellip;&hellip;</p>
<p>（PS：很多軟件計算傳輸速率用的是平均值。所以看起來傳輸速率並不是暴起暴落，而是先 600K 後 300K 然後 160K 最後又回到 20K；但實際上只有第一秒是 600K，第二秒已經是 20K 了；但它把兩秒的流量加起來一平均&hellip;&hellip;）</p>
</div>
</div>




</div>


</div>
</div>