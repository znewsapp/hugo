+++
date = "2017-07-05T20:00:00"
title = "CPU 風扇一罷工，電腦越來越燙越來越燙越來越燙……"
titleimage = "https://pic1.zhimg.com/v2-c9fa02fb3e2b25024c5c2ef08b71723c.jpg"
ga = 070520
+++

<div class="main-wrap content-wrap">
<div class="headline">

<div class="img-place-holder"></div>



</div>

<div class="content-inner">



<div class="question">
<h2 class="question-title">CPU 風扇停轉後會發生什麼？CPU 憑什麼燒不壞</h2>
<div class="answer">



<div class="content">
<p>當你坐在電腦前愉快的玩耍時，有沒有想過一個細思恐極的問題：如果忽然我的 CPU 風扇卡住不轉了，我的 CPU 會不會燒掉？</p>
<img class="content-image" src="https://pic3.zhimg.com/v2-ea76a34046743dfc888231d6f8b8b0f2_b.jpg" alt="">
<p>亦或整個主機被融化掉？</p>
<img class="content-image" src="https://pic1.zhimg.com/v2-7a44dfb1d0629bd9a40fc3572aa1dda4_b.jpg" alt="">
<p>值得慶幸的是，聰明的工程師們早已開發出有效的處理器溫度監控、保護技術。以特殊而敏銳的&ldquo;嗅覺&rdquo;隨時監測 CPU 的溫度變化，並提供必要的保護措施，使 CPU 免受高溫下的滅頂之災。在我們看來，探索這項技術如同開始一段神祕而有趣的旅程，何不與我們同行？</p>
<p><strong><strong>歷史</strong></strong></p>
<p>建立 CPU 溫度監控系統，首先要選擇一種合適的溫度測量器件。能夠測量溫度的器件有很多種，如熱敏電阻、熱電偶和半導體溫度傳感器等。電腦中最早使用熱敏電阻（Thermal Resistor ，簡稱 Thermistor）作爲測溫元件，CPU 插座下豎立的球狀或帶狀的小元件，就是熱敏電阻。但這種接觸式測溫元件和 CPU 接觸不夠緊密，CPU 核心（die）發出熱量由芯片封裝向外部散熱，其表面溫度和核心溫度之間約有 15℃～30℃ 的溫差，同時因芯片封裝形式不同，及環境溫度的不同而難以確定。由於熱敏電阻先天不足帶來了一個十分嚴重的問題：表面溫度不能及時反映 CPU 核心溫度變化，用專業術語說就是存在一個時間滯後的問題。在這種背景之下，如果再以表面溫度作爲控制目標，保護電路尚未做出反應，CPU 可能已經命歸黃泉了。</p>
<p>在這種情況下，Intel 在 Pentium Ⅱ和 Celeron CPU 中植入了熱敏二極管（Thermal Diode）直接測量核心溫度，開創了半導體測溫技術的先河，術語叫做 DTS（數字溫度傳感器，digital thermal sensor）。與此同時，是在 CPU 內部集成了溫度控制電路（Thermal Control Circuit，TCC），由其自身執行溫度控制功能。在 DTS 溫度超過 CPU 的額定核心最高溫度（TjMAX，maximum junction temperature）時會引發 CPU 的降溫措施，減慢 CPU 的執行速度。</p>
<p>那麼如何減慢 CPU 的執行速度呢？不外乎讓 CPU 做做停停磨洋工和做的慢一點兩種。在 Pentium Ⅱ時同時引入的 TM1（Thermal Monitor1）就是磨洋工做法，而在 Pentium4 引入的 TM2（Thermal Monitor2）則是讓 CPU 乾的慢點。如下圖：</p>
<img class="content-image" src="https://pic2.zhimg.com/v2-62f0d6b44928fe66c962f5954f2f05d5_b.jpg" alt="">
<p>可以過熱會引發 PROCHOT# 信號，這時 TM1 會將一半的 Duty cycle 關掉，就是幹一下，歇一下。與 TM1 相比，TM2 可以提供更智能，更有效的處理器熱量功耗的管理方式，在保證處理器基本性能的前提下儘可能在滿負荷情況下降低處理器的功耗和溫度。它會降低 CPU 頻率，與此同時通過與電壓管理模塊 VR 通訊，降低 CPU 電壓，雙管齊下保證 CPU 溫度降低。</p>
<p>也許你還有疑問，如果降頻還不足以降溫呢？畢竟風扇不轉後再慢的速度，CPU 溫度還是會上升啊！下面我們從硬件和軟件兩個角度來看看原理細節。</p>
<p><strong><strong>原理</strong></strong></p>
<p>爲什麼我們要分成硬件和軟件兩部分來講呢？因爲依靠單純的硬件和單純的軟件都有各自的問題：</p>
<p>1. <strong>純硬件</strong>：缺點是軟件如操作系統不參與，OS 無從知道硬件過熱，誰也不希望文件寫着寫着忽然斷電，文件都丟失了。</p>
<p>2. <strong>純軟件</strong>：軟件容易死掉，假使操作系統宕機，純軟件方法沒有辦法繼續降低 CPU 溫度，會導致 CPU 燒燬。</p>
<p>只有結合軟件和硬件，才能提供保障和有好的用戶體驗。軟件預先報警和阻止溫度上升，硬件在軟件行動不利後插手進一步阻止溫度上升，並在危急時刻自動切斷電源。</p>
<p><strong>硬件</strong></p>
<p>在 Core2 後，Intel 融合了 TM1 和 TM2,提出了自適應溫度監控（Adaptive Thermal Monitor），它實際上是結合了兩者。Intel 在每個內核和核顯上都放置了 DTS，並通過 TCC 隨時監控各個 DTS 的狀況，這些 DTS 的溫度值可以通過 MSR 或者 PECI 總線進行讀取。CPU 溫度上升後，Intel 爲保障系統安全設置了兩道防線：</p>
<p>1. <strong>PROCHOT#</strong></p>
<p>爲保證 CPU 工作在額定最大功率下（thermal design power ，TDP），Intel 爲 CPU 設定了額定核心最高溫度（TjMAX，maximum junction temperature）。TjMAX 是系統可以正常工作的最高溫度，它通常是不能修改的。當 CPU 內任何 DTS（數字溫度傳感器，digital thermal sensor）高於 TjMAX 後，CPU 的 PROCHOT# 信號線就會被置起。PROCHOT# 信號線通常是雙向的（在某些低端 CPU 上是隻能 in,或 out）,它可以通知外部 EC、BMC 等芯片 CPU 溫度過高，也可以用於 CPU 感知外部某器件溫度過高，而一樣進入 CPU 降溫模式：減慢 CPU 的執行速度。</p>
<blockquote>&ldquo;現在很多筆記本廠家都引入了一種名叫 BD PROCHOT（Bi-directional processor hot）的功能來解決高端 GPU 和 CPU 的發熱問題。其核心原理就是在獨顯工作的時候，當其溫度超過某一閾值，利用 PROCHOT# 通知 CPU 降頻以達到減少發熱的目的。反過來亦然，詳情見文後的擴展閱讀部分。&ldquo;</blockquote>
<p>PROCHOT# 是 CPU 的第一道防線，它是溫度變高，TCC（溫度控制電路，Thermal Control Circuit）反應的結果而不是原因。當這條黃線被跨過後，CPU 電壓管理模塊立刻行動起來：</p>
<p><strong>A.&nbsp;</strong>立刻利用 TM2 降低頻率和電壓，直到 DTS 不再超過 TjMAX。因爲可以選擇的頻率和電壓有很多檔，頻率和電壓是按照一定算法逐漸降低的，力度也是逐漸加大。</p>
<p><strong>B. </strong>如果溫度繼續上升到一個 Delta 值後，TM1 也會起作用，刪除掉一部分工作週期，讓 CPU 多休息一下。這時實際的效果是 TM1 和 TM2 的疊加。</p>
<p>2. <strong>THERMTRIP#</strong></p>
<p>爲保證 CPU 不會被毀壞，這是最後一道防線，當發生災難性溫度時（catastrophic Critical Temperature），THERMTRIP# 會被置起用以通知外部管理器件，同時 CPU 電源管理器會立刻強制關閉電源。這是一種類似保險絲的熔斷機制，你會看到系統立刻掉電了，只有在系統涼下來之後，你才能恢復上電。</p>
<p>這裏需要特別指出的是，主板廠商根據需要，可以在 BIOS 設定一個比 TjMAX 更低的溫度來規避可能的風險，這個溫度同樣也可以產生 TjMAX 一樣的相關動作。</p>
<p>好了，CPU 有了這兩個雙保險，看起來性命無憂了，但是我們的數據呢？達到 THERMTRIP# 可是會自動斷電的。這就要靠軟件來保證了。</p>
<p><strong>軟件</strong></p>
<p>要讀懂軟件需要 ACPI 的背景知識（<a class="internal" href="https://zhuanlan.zhihu.com/p/25893464">ACPI 與 UEFI - 知乎專欄</a>）。ACPI 規定了幾個溫度閾值，如下圖：</p>
<img class="content-image" src="https://pic3.zhimg.com/v2-dd293e0a9d5cf2426dfeca97ab83ce1e_b.jpg" alt="">
<p>BIOS 可以設置這些閾值的具體數值，並通過溫度中斷告訴 CPU 閾值被突破。操作系統的 OSPM 在超過_PSV 的溫度被報告後，會開始利用 EIST（P-State，<a class="internal" href="https://zhuanlan.zhihu.com/p/25675218">CPU 省電的祕密（一）：EIST - 知乎專欄</a>）降頻和利用 T-State 來關掉一部分有效時鐘週期，這點和 TM1 和 TM2 十分類似，不過是 OS 發起的。在突破 AC1 和 AC0 後，OS 通過 ACPI 提供的方法瘋狂提高風扇轉速，盡力把情況控制在自己的掌握之中。當溫度繼續上升，到達_CRT 時，OS 會立刻發起強制關機，避免數據丟失。通常_CRT 溫度會小於 THERMTRIP# 的溫度。這種控制溫度的方法叫做 on demand thermal mode。</p>
<p>這麼多的溫度閾值，軟件方法和硬件方法，他們是怎麼協同工作的呢？我們通過一個例子來串聯一下所有的知識點。</p>
<p><strong><strong>Case Study</strong></strong></p>
<p>還是回到我們最初的例子。你正在愉快的玩着遊戲，忽然有什麼事情發生了：周圍忽然好安靜。喧囂的 CPU 風扇忽然沒了聲音，更糟糕的是，你的操作系統也忽然死機了，遊戲的人物僵住了。</p>
<p>正在你腦子裏在考慮是不是某個敵人放出了時間停止魔法，你的電腦機箱裏面正在進行一場溫度與時間的賽跑。CPU 溫度越來越高了，一個個報警器都開始運作了：</p>
<p><strong>1. </strong>溫度首先突破軟件的_PSV。因爲 OS 死掉，CPU 溫度繼續升高。</p>
<p><strong>2. </strong>連續突破_AC0、_AC1 和 TjMAX。OS 還是無所作爲，硬件 Adaptive Thermal Monitor 開始發揮作用，降頻和抽頻，溫度上升有所減緩，但因爲風扇不轉，溫度繼續上升。</p>
<p><strong>3. </strong>突破_CRT。太可惜了，因爲 OS 死機，沒有抓住最後的機會保存你的遊戲，你的進度丟失了。</p>
<p><strong>4. </strong> 突破 THERMTRIP#! 你就聽吧嗒一下，你的世界更清淨了，電腦直接關機了，電源風扇和顯示器都關閉了。</p>
<p>這時如果你不信邪，按下電源鍵試圖再次開機，會發現沒有任何反應。你拆開機箱，折騰了半天，徒勞無功，並開始懷疑人生。最後抱着僅剩的一點點希望，你顫抖的手按向電源，同時向上天祈禱。哇，開機了，電腦沒壞啊！這時你應該注意到了呆掉的 CPU 風扇，並意識到 CPU 溫度管理救了你一命。誰說這不是個智能家電，你的眼睛裏充滿着劫後餘生之後感動的淚水！</p>
<hr>
<p>歡迎關注微信公衆號：UEFIBlog</p>



</div>
</div>
</div>


</div>
</div>