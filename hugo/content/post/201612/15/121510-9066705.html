+++
date = "2016-12-15T10:00:00"
title = "手機沒聯網，支付寶也支付成功了，這……靠譜嗎？"
titleimage = "http://pic2.zhimg.com/cfa05454d566485d4a28a1b62f75563d.jpg"
ga = 121510
+++

<div class="main-wrap content-wrap">
<div class="headline">

<div class="img-place-holder"></div>



</div>

<div class="content-inner">




<div class="question">
<h2 class="question-title"></h2>

<div class="answer">

<div class="content">
<p>用支付寶時發現沒開網絡也能付款成功，原理是什麼呢？有沒有被破解的可能？</p>
</div>
</div>


</div>





<div class="question">
<h2 class="question-title"></h2>

<div class="answer">



<div class="content">
<p>事實上支付寶和微信的&ldquo;當面付&rdquo;產品，是一款聯機在線支付產品，所以不允許雙方均離線的場景下支付（這一點和公交卡圈存支付不一樣，公交卡的近場支付事實上允許雙方脫機）。</p>
<p>題目中所知的支付寶和微信沒有網絡，指的都是消費者客戶端沒有網絡，而不是雙方都沒有網絡。</p>
<p>嚴格來說，當面付產品（特指商戶主動掃消費者錢包客戶端上的 token 碼進行支付的形態）必須要商戶在線方可進行聯機交易，原因有以下兩點：</p>
<ol>
<li>支付公司爲了保證資金安全必須要確保每筆用戶的支付行爲背後都真正發生了資金扣款，所以在線聯機確保支付成功是必要的。<strong>（這裏解釋了爲什麼不允許雙方脫機）</strong></li>
<li>商戶爲了確保用戶的支付結果可信賴，必須要自己的終端或者系統從支付公司獲得支付結果，而不能以消費者的支付結果憑證作爲結論。以傳統 POS 業務舉例，你可以認爲你的刷卡信息等同於支付寶的當面付碼，商戶必須要看到 POS 機打出支付成功單據後才認爲支付有效，如果 POS 支付超時沒有回執，光憑客戶手中的銀行短信通知是不會讓客戶走的，而是會衝正掉上一筆交易讓客戶重新刷一筆。<strong>（這裏解釋了爲什麼要選擇商戶必須聯機的方案）</strong></li>
</ol>
<p>那麼，我們來看看一個標準的當面付產品的信息流是什麼樣的（原諒我草草畫了一下）：</p>
<img class="content-image" src="http://pic4.zhimg.com/70/v2-17cfb693061bc9171bb42e941c85920f_b.jpg" alt="">
<p>我們可以看到在這個圖裏紅色圈圈部分，商戶系統和支付寶系統是對接上的，所以商戶系統是聯機的&mdash;&mdash;而用戶的手機，在展示 code 的時候，我並未強調是否和支付寶服務端聯機。</p>
<p>事實上，不論是微信還是支付寶都支持兩種用戶碼生成模式，即在線碼和離線碼。</p>
<p>在線碼其實很容易理解，用戶目前是登錄錢包的狀態，只要點擊【付款】按鈕，客戶端就向支付寶的服務端申請一個針對這個客戶賬戶的支付憑證碼並展現到客戶手機上。</p>
<p>這個支付憑證碼在支付寶的服務端會有一組數據庫記錄其與真實客戶賬戶之間的關聯，並且這份關聯的有效期爲 60S，超過時效即便商戶上送這個碼，支付寶也會認爲這是作廢碼而不予處理。</p>
<p>用戶每次點開【付款】、等待超過 60S、主動刷新付款碼，都會觸發客戶端向服務器申請一個新碼的請求。</p>
<p>這個方案的好處是：</p>
<ul>
<li><strong>相對</strong>安全，每次碼都是服務端生成。</li>
<li>業務靈活，即便對碼的安全算法等進行較大的調整，也不用升級客戶端，因爲是服務端發碼。</li>
</ul>
<p>這個方案的壞處也顯而易見：</p>
<ul>
<li>用戶的手機客戶端必須在線聯網，如果沒有網絡則無法獲取付款碼</li>
<li>用戶即便在線，如果網絡連接不好，也會出現點了付款等好久纔看到碼的情況，體驗會不可控。</li>
</ul>
<p>爲了解決在線碼方案的問題，離線碼方案就出現了。</p>
<p>離線碼的基本技術原理其實也不復雜，可以參考 @反方向的鐘 的回答，比較簡單的實現方式是：</p>
<p>用戶登錄後，服務端通過可信網絡向用戶客戶端發送一個<strong>種子數據</strong>（每個客戶的種子數據唯一，換用戶登錄後銷燬原種子，重新下載種子）本地保存，當用戶點擊【付款】時，客戶端利用這個種子數據 + 時間戳 + 一套安全算法可以生成一串數字，即離線碼。</p>
<p>當用戶使用離線碼支付時，服務端通過一定算法校驗這個碼的確是來自於這個用戶，隨即確認用戶授權完成支付。</p>
<p>離線碼的好處不言而喻：</p>
<ul>
<li>用戶無需在線，就算在地下室等沒有網絡的場景一樣可以使用</li>
<li>由於不依賴網絡，所有碼本地生成，所以客戶體驗很好，一點付款碼就能出來</li>
</ul>
<p>那離線碼的劣勢呢，我們看看：</p>
<ul>
<li>用戶 root/ 越獄手機後，保密存儲的種子數據有可能被不法分子利用惡意程序獲取到，導致離線碼被隨意生成用於消費。</li>
</ul>
<p>恩&hellip;&hellip;怎麼說呢，畢竟現在不是發燒友主動 root 越獄的用戶並不多，這是其一。</p>
<p>即便是 root 越獄，如果用戶使用手機的習慣良好，被惡意程序攻擊手機的概率也很低，這是其二。</p>
<p>每家公司都有自己的安全團隊去保障自己客戶端的數據安全，並不是說 root 的用戶就只能坐以待斃了，否則微信和支付寶早被搞破產了，這是其三。</p>
<p><strong>當然從我個人的角度來說，普通用戶我都不建議去 root 或者越獄。</strong></p>
<p>這個問題最粗暴的方案就跟反方向的鐘所說的一樣，監測到系統被 root 了就對用戶限權（很多銀行的客戶端方案都是這麼搞的）。</p>
<p>作爲直接面向消費者市場且充分競爭的產品，微信支付和支付寶斷然不會採用上面那個方案的。</p>
<img class="content-image" src="http://pic1.zhimg.com/70/v2-80819bc6e1aa3972b91130ea65ffb418_b.jpg" alt="">
<p>怎麼能又開放離線碼給用戶，又能確保用戶支付安全，本身也是支付公司安全競爭力的一部分，這裏就省略幾萬字了。</p>
<ul>
<li>數據碰撞可能導致 A 用戶的碼扣到 B 用戶的賬戶</li>
</ul>
<p>恩，這裏涉及一些算法問題，業務上就是碰了巧了 A 用戶碼算出來和 B 用戶碼一模一樣且都有效（兩個客戶端都沒作弊）。</p>
<p>在線碼之所以可以避免這個問題是因爲在線碼是服務端發的，可以控冪等。</p>
<p>離線碼是客戶端自己根據算法生成的，所以沒法控。</p>
<p>其實原因和哈希算法的數據碰撞類似，是個小概率的純技術問題，就不展開贅述了。</p>
<p>解決方案：優化算法（確保碰撞概率低到一定程度甚至杜絕），如果真的出現就認栽給客戶賠錢（賠多了技術部門老大就肯定痛定思痛優化算法了）。</p>
<p>事實上這個問題發生的概率極低極低，所以可以忽略不計。</p>
<ul>
<li>算法調整不如在線碼靈活</li>
</ul>
<p>因爲離線碼生成邏輯都在客戶端，所以通常來說安全算法升級會導致客戶端升級，比在線碼升級更影響用戶一些。</p>
<p>分析到上面這層，各位產品經理相信應該就知道如何做方案選型了。（裝個逼，事實上我覺得了解到上面那個層面是支付行業產品經理的基本素質）</p>
<p>後話：</p>
<p>我在寫這個答案的時候其實都在刻意迴避公司實現這些業務的具體邏輯和算法。而我個人並非當面付產品的產品經理，所以大家放心，這篇文章不算泄密。</p>
<p>寫這個答案的目的是希望能儘量站在產品和業務角度還原業務原理，希望更多的非行業內的知友知其然，也知其所以然。</p>
</div>
</div>




</div>


</div>
</div>