+++
date = "2016-08-17T08:00:00"
title = "「這年頭還有安全的 USB 設備嗎？」"
titleimage = "http://pic2.zhimg.com/b1bf3422b15f3731a8ba3ab486c0a70d.jpg"
ga = 081708
+++

<div class="main-wrap content-wrap">
<div class="headline">

<div class="img-place-holder"></div>



</div>

<div class="content-inner">



<div class="question">
<h2 class="question-title"></h2>
<div class="answer">



<div class="content">
<p>* FreeBuf 專題報道，未經許可禁止轉載</p>
<blockquote>在正式開談 USB 安全之前，還是照例來分享一個很有意思的案例：2014 年年末，來自 Reddit 的報道，某大公司高管電腦感染了惡意程序。公司的安全研究人員就調查惡意程序來源，但檢查了所有傳統可能的感染途經都一無所獲。於是他們開始考慮其他突破口，從這位高管的飲食起居入手，翻來覆去地查，最後發現問題居然出在高管的電子煙身上。<br><br>&ldquo;這是一款中國造的電子煙，充電裝置部分包含了硬件編碼的惡意程序。&rdquo;而這款電子煙是通過 USB 口充電的，這名高管爲了充電，順手會將其插入到公司的電腦上，於是電腦就感染了惡意程序。</blockquote>
<p>在這一例中，如果惡意程序做得更加隱祕，那麼整個攻擊過程甚至可以達到神不知鬼不覺。這其中的傳播核心，就是我們要談的&ldquo;USB 安全&rdquo;。</p>
<img class="content-image" src="https://pic4.zhimg.com/cad209d6e08cb9996855b53d6c288447_b.jpg" alt="">
<p><strong>USB 安全？這是什麼意思？</strong></p>
<p>我們擅自提&ldquo;USB 安全&rdquo;這個詞彙，其實是不準確的。因爲 USB 本質上只是一種通用串行總線&mdash;&mdash;總線有很多啊，SATA 總線、PCIe 總線等等，這有什麼樣的安全話題可談呢？可能 USB 充其量可作爲惡意程序傳播的途經。我們說&ldquo;USB 安全&rdquo;，和說&ldquo;網線安全&rdquo;是不是感覺差不多荒謬？</p>
<p>不過大概是因爲 USB 作爲替代古代各種接口的明星級統一標準，而且 USB 又不像 Thunderbolt 之類的接口一樣需要高昂的授權費用，當代世界的海量設備採用 USB 接口也是種必然。有趣的是，我們經常將採用 USB 接口的設備稱作 USB 設備（卻沒有人將 PC 內置的硬盤稱作 SATA 設備或者 PCIe 設備），這也是我們這裏談 USB 安全的基礎。</p>
<img class="content-image" src="https://pic4.zhimg.com/b32ca8999d8b1577fbf912347d2991bb_b.jpg" alt="">
<p>由於 USB 當代的使用如此廣泛，所以 USB 設備也就成爲了惡意程序傳播的重要載體。但如果只說 USB 設備作爲惡意程序的傳播途徑，那麼任何接口實際上也都存在這種傳播的可行性。比如說 U 盤能夠傳播病毒，Thunderbolt 移動硬盤也行，連光盤都可以。</p>
<p>總的說來，我們要談所謂的 USB 安全，並不是 USB 在數據傳輸過程中存在安全問題，或者某類 USB 接口規格（如 Type-C）某個針腳存在設計缺陷，而是 USB 接口或總線作爲惡意程序的一個重要途經，存在安全問題，以及 USB 協議、驅動存在的安全問題。</p>
<p>因此針對 USB 安全，有 3 點可談。其一，USB 是個具有相當普遍性的標準，鼠標、鍵盤、電子煙、外置聲卡都用 USB 接口，且即插即用。所以在物理接口中，它對惡意程序的傳播大概是除了網絡適配器接口之外，效率最高的。其二，USB 協議可被攻擊者利用，這也將是本文要談到的重點。其三，最高級的 USB 0day 漏洞攻擊。</p>
<img class="content-image" src="https://pic1.zhimg.com/43bb61fb0b7ead963b0c949225c6a5fc_b.jpg" alt="">
<p><strong>autorun.inf 時代！U 盤病毒？</strong></p>
<p>在網絡還不像現在這麼盛行的年代，可移動存儲設備是傳播病毒的重要方式。就是將惡意程序放在 U 盤，或者移動硬盤，甚至軟盤中&mdash;&mdash;在不同的 PC 交換數據的過程中，就可以達到傳播病毒的作用。再高明的惡意程序也需要人類去打開才能運行，巧在像 Windows 這類操作系統，爲了加強使用體驗，系統中有個針對移動存儲介質的 AutoPlay/AutoRun 自動播放功能。</p>
<p>原本自動播放的功能是，針對 CD/DVD 多媒體光盤可實現插入即播放，而針對 Windows 安裝介質，插入就能立即彈出安裝程序。絕大部分同學應該都知道移動存儲介質的根目錄下的 autorun.inf 文件就負責自動播放功能，打開形如以下樣式：</p>
<div class="highlight">
<pre><code class="language-text">[autorun] open=setup.exe icon=setup.exe,0label=My install CD
</code></pre>
</div>
<p>相較光盤，U 盤的可讀寫方便性明顯更勝一籌，如果這裏的 setup.exe 是個病毒，那麼設備插入 U 盤，系統就會自動運行該病毒。所以病毒通過 autorun.inf 文件實現 U 盤插入即啓動惡意程序的功能，實在是太方便了。同事間交換數據，大家的電腦都插一遍帶毒 U 盤，自然就都感染上了。已經被感染的設備，再感染插入設備的新 U 盤，以此達到擴散的目的。</p>
<img class="content-image" src="https://pic3.zhimg.com/3ecf6ad45336a24684c9651311ad0b4e_b.jpg" alt="">
<p>這是 U 盤傳播惡意程序的常規手法，也因此有些人將 autorun.inf 稱作&ldquo;U 盤病毒&rdquo;，雖然這東西其實是很無辜的。實際上，要杜絕這種方式的病毒傳播也並不困難，一方面是在系統中禁用移動存儲介質的自動播放或自動啓動功能，另一方面也可以禁止程序在 U 盤中創建 autorun.inf 文件，達到 U 盤不會傳播病毒的目的。</p>
<p>可以說，autorun.inf 是過去在民間最廣爲流傳的 U 盤病毒傳播方式。很多 U 盤病毒查殺工具都主要針對 autorun.inf 進行圍剿。尤其從 Windows XP SP2 開始，系統針對&ldquo;USB 大容量存儲設備&rdquo;和 ZIP 驅動器，自動播放功能是默認開啓的。微軟眼見形勢不妙，從 Windows Vista 和 Windows Server 2008 開始，針對插入 U 盤的的系統默認行爲，已改爲詢問用戶是否執行自動運行指令。現如今 autorun.inf 的時代幾乎已經過去。</p>
<p><strong>用 U 盤來釣魚會不會成功？</strong></p>
<p>如前文所述，其實上面談到的 U 盤安全問題並不是 USB 設備的專屬，任何移動存儲設備（甚至連內置硬盤）都存在這樣的問題。所以嚴格意義上，這種安全問題根本就怪不到 USB 頭上，如果一定要怪，就如前文所述，只是因爲 USB 實在是太普遍了。</p>
<img class="content-image" src="https://pic1.zhimg.com/958dbf4ea957d6b2db1b62f54fe9d2f0_b.jpg" alt="">
<p>前不久剛剛結束的 Black Hat USA 2016 黑客大會上，谷歌反欺詐研究團隊負責人 Elie Bursztein 分享了一個議題，名爲&ldquo;Does dropping USB drives really work？&rdquo;（丟 U 盤進行社工攻擊真的有效嗎？）他嘗試在伊利諾伊大學校園裏各處丟棄 297 個 U 盤，看看有沒有好奇心重的人會撿回去看 U 盤裏究竟有什麼。如果說 Bursztein 丟的是 297 塊 SATA3 硬盤（Lol），攻擊方式理論上是一樣的，但攻擊效果有多麼糟糕是可想而知的。可見 USB 的普及性，是我們在此討論其安全性的依據。</p>
<p>美國計算機行業協會去年曾經發起過一項調查，結果顯示 17% 的人在撿到 USB 設備後會直接連電腦&mdash;&mdash;這個數據可能還過於保守。Bursztein 的調查結果明顯更激進：135 個 U 盤（也就是 45%）被人撿走後都連接了電腦，這些人還打開了其中的文件，其上的&ldquo;惡意程序&rdquo;給 Bursztein 回傳了數據。</p>
<p>好在這還只是個實驗，並不存在真的&ldquo;惡意&rdquo;。Bursztein 的研究團隊是這麼做的：他們沒有用 autorun.inf，因爲現在的操作系統根本就不吃這套，Mac 連自動運行功能都不支持，他們的方法是：釣魚。</p>
<img class="content-image" src="https://pic2.zhimg.com/0e2920efde251c1ca9e6d9a2996150c5_b.jpg" alt="">
<p>研究團隊給這 297 個 U 盤分別貼了些標籤，甚至還明確寫上了 U 盤所有者（以及歸還地址），即便在這種情況下還是有 135 個 U 盤被好奇心重的同學打開了。U 盤裏面的文件迷惑性地寫上了&ldquo;期末考試&rdquo;&ldquo;機密&rdquo;等字樣，實際上這些文件都是 HTML 格式的，文件中有張圖片，調用了研究團隊服務器的地址&mdash;&mdash;這樣一來研究團隊就知道，有人打開了文件。</p>
<p>除此之外，HTML 文件打開後有個問卷調查，詢問這些好奇心寶寶：你們爲啥要插人家的 U 盤呀！的確也有 20% 的人蔘與了調查，超 2/3 的人表示他們其實是想歸還 U 盤的（Really？），18% 的人承認他們是好奇，14% 的人給出了其他解釋。</p>
<p>就這一個例子，我們就不難看出 U 盤釣魚的成功率還是相當高的。如果這些 HTML 文件都換成惡意程序，或者調查問卷改成詢問用戶名密碼的&ldquo;釣魚問卷&rdquo;，又有多少人會栽在其中呢！美劇《黑客軍團（Mr Robot）》中就出現了用 U 盤釣魚的橋段，看樣子這根本就不只是個傳說！</p>
<img class="content-image" src="https://pic1.zhimg.com/4ea7f6fad3efe4ba32691b8932be1f34_b.jpg" alt="">
<p><strong>U 盤攻擊絕殺：僞裝成 HID 設備</strong></p>
<p>還是那句話，上面兩部分談的實際上都仍是將 USB 設備作爲傳播惡意程序的載體，就好像 U 盤釣魚，其本質和丟個軟盤來釣魚（Lol），以及郵件釣魚是沒差別的，原罪不在 USB 設備身上。如果用這種方法來談 USB 安全，實際上還有很多內容可說，比如說 USB 接口是入侵 ATM 機的重要途徑，還有 USB Key 這類作爲數據解密的安全手段，都不過是將 USB 作爲工具。</p>
<p>那麼有沒有 USB 本身的原罪可談呢？有！可以從 USB 的協議入手。USB 不止 MSC（大容量存儲）設備這一種，現在的 USB 接口支持這麼多功能，協議其實也五花八門，自然不光有相關 MSC 的協議，什麼 USB Power Delivery（USB 快速充電規範）、USB OTG（SRP、HNP 協議，兩個外設間傳輸）等等，還有一個 USB HID 設備類協議。這裏的 USB HID，近兩年來已經成爲 USB 設備攻擊的絕殺了。</p>
<p>HID 也就是 Human Interface Device，是與人交互的設備。其實 USB-HID 設備現如今已經相當普遍了，比如 USB 鍵盤、鼠標、手柄等等。這要怎麼利用呢？在 2014 年的 Black Hat 黑客大會上，安全研究人員 Karsten Nohl 和 Jakob Lell 發表了演講，提到一個有些驚世駭俗意味的 USB 攻擊手段，名叫 BadUSB，部分利用了 HID 的特點。</p>
<img class="content-image" src="https://pic4.zhimg.com/da70900045ffd2a20371d2702a7104f7_b.jpg" alt="">
<p>上面說的好玄乎，所以下面再來舉個栗子：鍵盤都用過吧？有沒有試過不用鼠標，純粹用鍵盤來進行各項系統操作呢？有經驗的同學應該知道，其實也不難。那麼如果有這麼一個 U 盤，它能夠僞裝成鍵盤，通過腳本執行一系列鍵盤敲擊操作，是不是感覺就能控制你的系統了？這其實就是 BadUSB 攻擊利用 USB 協議的示例。被 BadUSB 感染過的 U 盤不僅能夠僞裝成 USB 鍵盤，還能僞裝成 USB 網卡&mdash;&mdash;篡改 DNS，這樣一來所有的 DNS 查詢就能發往攻擊者的服務器，可進行重定向攻擊。</p>
<p>一旦這種攻擊得以實現，那麼攻擊方式自然也就變得五花八門了，只有想不到沒有做不到，最重要的是跨平臺&mdash;&mdash;因爲各系統平臺遵循一致的 USB 標準。詳情可參見我們當年發佈的一篇文章《<a class=" wrap external" href="https://link.zhihu.com/?target=http%3A//www.freebuf.com/articles/terminal/42616.html" target="_blank" rel="nofollow noreferrer">解密 BadUSB：世界上最邪惡的 USB 外設</a>》。</p>
<img class="content-image" src="https://pic3.zhimg.com/b71da09bd4657559049869ecb2dc652a_b.png" alt="">
<p>說到底，這種 HID 模擬攻擊不就是當年黑客們很愛的 USB 橡皮鴨（USB Rubber Ducky）嗎？問題是橡皮鴨的內部硬件很彪悍，有個 60MHz 主頻的處理器、microSD 擴展插槽。普通 U 盤何以實現這樣的攻擊手段？這個問題其實才是 Karsten Nohl 和 Jakob Lell 這兩位研究人員的高明之處，也是這些 U 盤在感染 BadUSB 之後的可怕之處。</p>
<p>一般 U 盤的構成除了我們需要用到的存儲數據的閃存部分，還有主控芯片，或者叫控制芯片。主控芯片一般會指定某些部分的單元用於存儲固件驅動（似也有主控芯片本身就包含了固件閃存）。這裏的固件就類似於操作系統，控制軟硬件交互。Nohl 和 Lell 花了好幾個月的時間進行逆向工程，他們發現許多 U 盤都可以對固件部分進行重新編程（尤其是 PHISON 羣聯的主控芯片）。用戶根本就看不到固件部分，要隱藏攻擊代碼自然就非常容易了。</p>
<img class="content-image" src="https://pic2.zhimg.com/4c77fb1b081fb652859682ec81c34f69_b.jpg" alt="">
<p>這就是 BadUSB 得以成型的核心所在。另一方面當代操作系統爲了給 USB 設備提供最大的兼容性，USB 標準是允許一個 USB 設備具有多種輸入輸出設備的特徵的。這樣一來，通過重寫 U 盤固件，就能讓它僞裝成 USB 鍵盤、網卡甚至顯示器。通過這個假的鍵盤，輸入 U 盤固件中的惡意指令和代碼，還可以配合閃存中的惡意程序進行攻擊。</p>
<p>說白了，BadUSB 是令普通 U 盤都變身爲橡皮鴨，甚至攻擊性更強。這其中的加強體現在 BadUSB 的僞裝和傳播性方面。僞裝！很容易理解，看起來只是個普通 U 盤，而且即便格式化 U 盤也無法清除惡意代碼，因爲惡意代碼在固件中；傳播！當年 Nohl 和 Lell 在研究報告中有特別提到，BadUSB 理論上最大的威脅在於，通過一個 BadUSB 設備給計算機感染惡意程序之後，計算機也可以將 BadUSB 傳播到其他插入計算機的 U 盤：某個 U 盤在插入這臺計算機之後，計算機上的惡意程序就能夠對 U 盤固件進行重新編寫，U 盤主人根本就不會察覺到。</p>
<p>這麼一來，全世界的 U 盤都能通過這種方式被 BadUSB 感染，全世界沒有任何一個 U 盤是可被信任的，因爲根本就沒有反病毒軟件能夠查到。由此甚至可以引發一個問題：USB 設備是否已經到了根本就沒有安全性可言的地步？</p>
<img class="content-image" src="https://pic3.zhimg.com/b0a00a8ba517bd2b5b764c03964917ee_b.jpg" alt="">
<p>其實也不盡然，針對 U 盤固件，引入不可僞造加密簽名機制就是種方案，杜絕惡意程序的重新編寫。這就主要取決於閃存主控芯片製造商了。因爲有人指責 Nohl 說，他先前在 Black Hat 上的演講其實只針對臺灣羣聯的閃存主控芯片&mdash;&mdash;所以 2014 年年底，Nohl 還抽樣了 8 大主要芯片製造商的主控芯片：羣聯、Alcor、瑞薩、祥碩（華碩的子公司）、創惟、FTDI、微芯、Cypress。</p>
<p>結果發現情況異常複雜。的確有部分 USB 主控芯片對 BadUSB 免疫&mdash;&mdash;即無法對固件做重新編程，免疫的芯片佔到抽樣總數的一半，但每個品牌的表現都是很不穩定的。比如說，採用羣聯主控芯片的 U 盤都存在被 BadUSB 感染的風險，而祥碩則完全對 BadUSB 免疫，創惟的 USB 2.0 芯片沒問題，但更新的 USB 3.0 芯片就有問題。其他 USB Hub、鍵盤、攝像頭、鼠標等所用的控制芯片情況更是五花八門。而且實際上，即便是一個 USB 設備製造商的相同型號的產品，他們也會在不同批次中採用不一樣的主控芯片，比如金士頓所用的 USB 控制芯片就有五六種之多。</p>
<p>難不成以後我們要用 U 盤之前，都得先把 U 盤拆開看看主控芯片的型號不成？</p>
<p><strong>只要是 USB 接口就都不安全！</strong></p>
<p>不知道很多小夥伴有沒有留意過，斯諾登當年揭露 NSA 的文檔中提到了一款竊聽設備名爲 Cottonmouth（如下圖所示）。這就是個 USB 設備，據說能夠偷偷地往目標設備中安裝惡意程序。雖然文檔中並未詳述其具體機制，但斯諾登說：&ldquo;如果 Nohl 和 Lell 發現的這種東西早就爲 NSA 所用了，我也不會感到奇怪。&rdquo;或許很久之前，NSA 就已經在這麼幹了，那麼我們手裏的 U 盤&hellip;&hellip;</p>
<img class="content-image" src="https://pic1.zhimg.com/25f01aefa86594c0a60876a6cef3ae7c_b.jpg" alt="">
<p>但這還不是全部。既然 USB 標準是允許一個 USB 設備具有多種輸入輸出設備特徵的，那麼 USB 設備的僞裝實際上也就不僅限於僅針對 U 盤的 BadUSB 了，各種 USB 設備都可能出現僞裝的情況。從你的 USB 鼠標、鍵盤，到攝像頭、電子煙、充電寶。</p>
<p>除了文章開頭提到的電子煙，2014 年年末央視曝光&ldquo;改裝充電寶盜取隱私&rdquo;：看起來只是個充電寶，但實際上卻有存儲數據的能力，特別針對當時加密機制還沒有現在這麼完善的 iPhone 進行數據竊取。這麼想來，我們周圍但凡用 USB 接口的東西似乎都有帶毒帶馬的可能性，這世界真是太殘酷了&mdash;&mdash;說不定你已經被 NSA 鎖定，你的鼠標就帶 APT 木馬&hellip;&hellip;</p>
<img class="content-image" src="https://pic1.zhimg.com/d55ba6a6d3a06677bc21f8cd8cb3b6c0_b.jpg" alt="">
<img class="content-image" src="https://pic1.zhimg.com/17ff55c3e7f71749753e37d719dd6bd4_b.jpg" alt="">
<p>今年的 Black Hat USA 2016 大會上，分享丟 U 盤是否有效的 Elie Bursztein 不僅做了丟 U 盤的實驗，而且還教育人們如何才能做個完整版的、僞裝起來的 U 盤，那詳細程度，從選購芯片到最終 U 盤外部材料成型一條龍，所用的都是成本很低的現成材料（<a class=" wrap external" href="https://link.zhihu.com/?target=https%3A//www.elie.net/blog/security/what-are-malicious-usb-keys-and-how-to-create-a-realistic-one" target="_blank" rel="nofollow noreferrer">點擊這裏</a>）。</p>
<p>FreeBuf 先前也發表過一篇題爲《<a class=" wrap external" href="https://link.zhihu.com/?target=http%3A//www.freebuf.com/sectool/107242.html" target="_blank" rel="nofollow noreferrer">利用 Arduino 快速製作 Tennsy BadUSB</a>》的文章，用 Arduino Leonardo 單片機（似成本稍高），配合 Arduino IDE 簡單的代碼編寫，就做成了一個可僞裝成普通 U 盤的 USB 攻擊設備。以後要黑誰，送他個 U 盤或充電寶，比郵件釣魚大概有效多了。</p>
<p><strong>USB 攻擊的究極形態</strong></p>
<p>Bursztein 在 Black Hat USA 2016 大會上將 USB 攻擊分成了 3 大類，分別是社會工程（丟 U 盤），HID 僞裝和 0-day 漏洞利用。前兩種我們都已經在前文做了簡單的分析，最後一種 0-day 漏洞利用，他只稍作了解釋，主要利用的是 USB 驅動的 0-day 漏洞，只要計算機插上 USB 設備，就能立刻對計算機進行控制。</p>
<img class="content-image" src="https://pic4.zhimg.com/914e06afe6ec7f28866fd2a979180f8f_b.jpg" alt="">
<p>在他看來，0-day 漏洞乃是 USB 攻擊的究級形態，無論是複雜程度、可靠性還是隱蔽性都達到了至高境界（雖然因爲針對性強，所以跨平臺屬性不佳）。我們能夠列舉的此類案例實在稀有，因爲這幾乎沒有被廣範圍探討過。之前名噪一時的 Stuxnet 震網病毒，就利用了 USB（但似並非 USB 驅動的 0-day 漏洞）傳播&mdash;&mdash;Windows 系統中，.lnk 文件負責渲染 U 盤中的文件圖標，插入 U 盤的時候，資源管理器就會掃描其中的 .lnk 文件來顯示各種格式的文件，震網病毒就是將惡意程序插入到 .lnk 文件中&mdash;&mdash;整個過程是插入就執行的，所以其隱蔽性自然可見一斑。</p>
<img class="content-image" src="https://pic2.zhimg.com/60498104002a1f7394589afd69d5b995_b.jpg" alt="">
<p>不過這種例子實在稀有，大約需要投入大量時間和精力，極具針對性地進行攻擊研究。對一般人來說，U 盤釣魚和 HID 僞裝的確纔是最需要防範的。但在我們談了這麼多以後，是否還要說說 USB 安全的注意事項呢？</p>
<p>像 Nohl 說的，防範 USB 攻擊的最佳方案就是不要用 USB 設備！爲了這個目標，就請封死設備上的所有 USB 接口吧&hellip;&hellip;說正經的，因噎廢食當然不好，但來路不明的 U 盤甚至充電寶、電子煙都不要用，馬路上出現 U 盤，也請忽略之；自己的 USB 設備也不要去插不受信任的主機設備。用戶能做的，大概也只有這些了吧。</p>
<p>* FreeBuf 專題報道，作者 / 歐陽洋蔥，未經許可禁止轉載</p>



</div>
</div>
</div>


</div>
</div>