+++
date = "2016-08-29T08:00:00"
title = "一眼望去綠油油的就知道，這圖不知道被轉多少次了"
titleimage = "http://pic1.zhimg.com/4bea52db1accfed71f2a816c0837c5dc.jpg"
ga = 082908
+++

<div class="main-wrap content-wrap">
<div class="headline">

<div class="img-place-holder"></div>



</div>

<div class="content-inner">




<div class="question">
<h2 class="question-title">爲什麼圖片反覆壓縮後會普遍會變綠而不是其他顏色？</h2>

<div class="answer">



<div class="content">
<p><strong>業餘版概要：安卓的一個核心的部分的代碼，爲了優化執行速度進行了魔改，結果寫錯了代碼。結果導致 JPG 圖片壓縮發綠、崩壞。與安卓上的應用無關，它們是受害者（</strong></p>
<p><strong>專業版概要：問題出在 Android 提供的壓縮圖片接口上，準確的說是一個 Android 裏一個叫做 Skia 的庫上。而這個 bug 在 2016 年 4 月中旬被修復了，如果按照 Android 的發行來看，那就是從 Android 7 (Nougat) 開始才消除這個問題。</strong></p>
<p>前言：剛纔在社區裏和 @StarBrilliant 等人一起研究，現在應該可以下一個精確的定論了。如他的答案所說，問題出在 RGB 色彩空間轉換到 YUV 的時候。但問題不僅僅是精度下降，最大的問題是，錯誤的舍入（向下取整）。另外，JDCT_IFAST 方法會導致圖片嚴重劣化：&ldquo;格子狀崩壞&rdquo;、灰塊、黑白塊、畫面粗糙，但是題目問的僅僅是變綠，就不在這上面浪費篇幅了。</p>
<p>網頁模擬 by @StarBrilliant ：<a href="https://m13253.github.io/JPEGreen/">JPEGreen Simulator</a></p>
<p>歷史性的修復：<a href="https://github.com/google/skia/commit/c7d01d3e1d3621907c27b283fb7f8b6e177c629d">Use libjpeg-turbo for YUV-&gt;RGB conversion in jpeg encoder &middot; google/skia@c7d01d3 &middot; GitHub</a></p>
<p><strong># 是誰的鍋？</strong></p>
<p>百度貼吧是最多人批評的，而且&hellip;&hellip;出事的客戶端僅僅是 Android 系統上的。</p>
<p>我後來注意到 QQ 也有這個問題，特別是上傳頭像。以前一直不知道爲什麼有一些圖稍微有點綠，以爲是打開了新世界的大門（x</p>
<p>後來做了一點微小的測試，注意到百度貼吧、QQ，都會用 Android 系統提供的接口：</p>
<div class="highlight">
<pre><code class="language-java"><span class="n">Bitmap</span><span class="o">.</span><span class="na">compress</span><span class="o">(</span><span class="n">Bitmap</span><span class="o">.</span><span class="na">CompressFormat</span><span class="o">.</span><span class="na">JPEG</span><span class="o">,</span> <span class="n">quality</span><span class="o">,</span> <span class="n">outputStream</span><span class="o">);</span>
</code></pre>
</div>
<p>看起來都很乾淨&hellip;&hellip;難不成是系統的問題？</p>
<p>我自己做了一個我這輩子寫的第一個 Android 的小程序（我真不敢斗膽叫做 App），模仿一個正常的應用，反覆 JPEG 壓縮。發現還真是那麼回事。順便完善了一下，做成了&ldquo;效果拔羣的綠化器&rdquo;。</p>
<img class="content-image" src="http://pic2.zhimg.com/70/0e7731ee61b95ed4348bb5fa6d638ad9_b.jpg" alt="">
<p>源代碼已開放：<a href="https://github.com/LionNatsu/terribleGreen/blob/master/app/src/main/java/com/example/lion/myapplication/MainActivity.java">terribleGreen/MainActivity.java at master &middot; LionNatsu/terribleGreen &middot; GitHub</a>（開源許可證：Apache License Version 2.0，歡迎提供 PR）</p>
<p>現在就要說到 Android 系統到底爲什麼出了這個問題了。Android 系統自起誕生以來就引入了名爲 Skia 的圖像庫（Google 自家產品），用於處理圖像，其中包括把圖片壓縮成 JPEG（平時說的 JPG）。而 Skia 又是調用 libjpeg-turbo 來實現真正的壓縮過程的。爲了達到更好的壓縮效果，JPEG 算法本身，將通常屏幕上表示顏色的 RGB（紅綠藍）數值，轉換爲 YUV 數值（亮度，藍色分量，紅色分量）。正常情況下這個算法是輕微有損的。</p>
<p>但是 Skia 不走尋常路，將這個變換算法的各個常數複製到自己的代碼裏（當然是合法地），<strong>然後降低了精度，以達到更高的速度</strong>（專業準確地說，從 16 位定點數，降低到了 8 位定點數），這導致了更大的損傷。</p>
<p>最可怕的是&hellip;&hellip;在進行這個變換運算的最後一步，需要除以 256，而代碼中，<strong>採用了右移操作代替除法以提高執行速度</strong>（看不懂可以跳過）：</p>
<div class="highlight">
<pre><code class="language-cpp"><span class="kt">int</span>  <span class="n">y</span> <span class="o">=</span> <span class="p">(</span> <span class="n">CYR</span><span class="o">*</span><span class="n">r</span> <span class="o">+</span> <span class="n">CYG</span><span class="o">*</span><span class="n">g</span> <span class="o">+</span> <span class="n">CYB</span><span class="o">*</span><span class="n">b</span> <span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">CSHIFT</span><span class="p">;</span>
<span class="kt">int</span>  <span class="n">u</span> <span class="o">=</span> <span class="p">(</span> <span class="n">CUR</span><span class="o">*</span><span class="n">r</span> <span class="o">+</span> <span class="n">CUG</span><span class="o">*</span><span class="n">g</span> <span class="o">+</span> <span class="n">CUB</span><span class="o">*</span><span class="n">b</span> <span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">CSHIFT</span><span class="p">;</span>
<span class="kt">int</span>  <span class="n">v</span> <span class="o">=</span> <span class="p">(</span> <span class="n">CVR</span><span class="o">*</span><span class="n">r</span> <span class="o">+</span> <span class="n">CVG</span><span class="o">*</span><span class="n">g</span> <span class="o">+</span> <span class="n">CVB</span><span class="o">*</span><span class="n">b</span> <span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">CSHIFT</span><span class="p">;</span>
<span class="c1">// C?? 是已經擴大到 2^CSHIFT 倍的矩陣參數（-0.5 ~ 0.5），CSHIFT = 8</span>
</code></pre>
</div>
<p>這個操作並沒有什麼問題，數學意義就是除以 256。但是問題出在：</p>
<p>1、直接截斷了小數部分，等價於 trunc()。如果符號數是用補碼實現的。即全部往負數方向取整。如：1.2 &rarr; 1； 3.9 &rarr; 3；0.0 &rarr; 0；-5.1 &rarr; -6.</p>
<p>2、不符合規範：符號數（可正可負的數）不應該使用移位。移位是一個符號無關的操作，或者說是一個無符號數（僅正數的）變量才應該使用的操作。其結果也是無符號的，給符號數賦一個無符號數，是未定義的行爲。（因爲符號數的實現方式是 C++ 沒有限制的，儘管我見過的都是用&ldquo;補碼&rdquo;）</p>
<p><strong># YUV 值向負方向取整導致什麼？</strong></p>
<p>複習一下 YUV 的定義：</p>
<ol>
<li>Y，亮度，0.0 ~ 1.0；</li>
<li>U，或者叫做 Cb，藍色分量，-0.5 ~ 0.5；</li>
<li>V，或者叫做 Cr，紅色分量，-0.5 ~ 0.5。</li>
</ol>
<p>在 Skia 的代碼裏，YUV 三個值均對應到 0~255 的範圍。</p>
<p>因爲向下取整，所以誤差在 1 一個單位以內：0/256 到 1/256 也就是，YUV 三個值都變小 0.00% 到 0.39% 這個範圍。</p>
<p>看一下 U, V 這兩個決定顏色的值是如何變化的：</p>
<img class="content-image" src="http://pic2.zhimg.com/70/6d51626208ef196b3332f024361dba19_b.jpg" alt="">
<p>（圖片來自 Tonyle, Wikimedia Commons, <a href="https://commons.wikimedia.org/wiki/File:YUV_UV_plane.svg">File:YUV UV plane.svg</a>）</p>
<p>顯然，<strong>YUV 值向負方向取整，結果是呼之欲出的：變暗，變綠。</strong>（這裏的變暗是 YUV 裏的 Y 減小，並不完全準確對應人類視覺的明暗概念）</p>
<p>這個錯誤的舍入，使得：所有在 0 ~ 255 範圍內非整數的 YUV 值都受到影響。那麼某個像素被舍入到整數之後，下一次再壓縮 JPEG 應該會好一些吧？很不幸的是，隨之而來的大量其他有損操作（比如 DCT 變換之後濾去高頻）又會使得 YUV 值發生變化：如果發生變化，假設隨機產生關於 0 對稱的誤差，那麼實際上也有 50% 的機率使得這個數值 -1，因爲只要比原來的值小，都會被向下捨去。</p>
<p>這使得，圖片隨着 Skia 缺陷的色彩空間變換算法反覆壓縮，越來越綠。</p>
<p><strong>## 假如我們是 Skia 開發者，如何修復這個問題？（閱讀本節需要 C/C++ 常識）</strong></p>
<p>交回給 libjpeg-turbo 庫自己來做色彩空間變換。這也正是本文開頭提到的那個歷史性的修復具體做的：把原本 Skia 庫 YUV 轉換代碼全部刪掉了，把這個過程留給整個過程最底層的 libjpeg-turbo 庫自己來做，並且用默認的 JDCT_ISLOW 方法代替 JDCT_IFAST 方法，那麼自然就沒這個問題了。</p>
<p>注：libjpeg-turbo 是個運用極其廣泛的庫。可以說，基本上電腦上手機上能見到的 JPEG 壓縮的地方用的一般都是 libjpeg-turbo。（iOS 應該也是吧？我沒有蘋果設備抱歉&hellip;&hellip;Adobe 公司的魔法可能是另一回事）</p>
<p>如果不刪除呢？自己搗鼓：</p>
<p>* 本節所提到的代碼以及示例圖片可以在這裏找到：<a href="https://github.com/LionNatsu/greenError">GitHub - LionNatsu/greenError: Discover the reason how `terribleGreen`(my another repo.) works on Android.</a></p>
<p>首先我們要模擬一個 Skia 的 libjpeg-turbo 操作（略），然後，在把圖片遞交給 libjpeg-turbo 之前，把色彩空間像 Skia 一樣，做一個變換（矩陣數據完全與 Skia 相同）。</p>
<p>我們所要做的修復就是，把運算改成能夠對數字進行合理四捨五入的運算：</p>
<div class="highlight">
<pre><code class="language-cpp"><span class="kt">int</span> <span class="n">R</span><span class="o">=</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">G</span><span class="o">=</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">B</span><span class="o">=</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="cp">#if 1 </span><span class="c1">// Shift or float-divide (shift in Skia)</span>
  <span class="kt">int</span> <span class="n">Y</span> <span class="o">=</span> <span class="p">(</span><span class="n">R</span><span class="o">*</span><span class="n">CYR</span> <span class="o">+</span> <span class="n">G</span><span class="o">*</span><span class="n">CYG</span> <span class="o">+</span> <span class="n">B</span><span class="o">*</span><span class="n">CYB</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">CSHIFT</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">U</span> <span class="o">=</span> <span class="p">(</span><span class="n">R</span><span class="o">*</span><span class="n">CUR</span> <span class="o">+</span> <span class="n">G</span><span class="o">*</span><span class="n">CUG</span> <span class="o">+</span> <span class="n">B</span><span class="o">*</span><span class="n">CUB</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">CSHIFT</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">V</span> <span class="o">=</span> <span class="p">(</span><span class="n">R</span><span class="o">*</span><span class="n">CVR</span> <span class="o">+</span> <span class="n">G</span><span class="o">*</span><span class="n">CVG</span> <span class="o">+</span> <span class="n">B</span><span class="o">*</span><span class="n">CVB</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">CSHIFT</span><span class="p">;</span>

  <span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Y</span><span class="p">;</span>
  <span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">U</span> <span class="o">+</span> <span class="mi">128</span><span class="p">;</span>
  <span class="n">o</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">V</span> <span class="o">+</span> <span class="mi">128</span><span class="p">;</span>
<span class="cp">#else</span>
  <span class="kt">double</span> <span class="n">Y</span> <span class="o">=</span> <span class="p">(</span><span class="n">R</span><span class="o">*</span><span class="n">CYR</span> <span class="o">+</span> <span class="n">G</span><span class="o">*</span><span class="n">CYG</span> <span class="o">+</span> <span class="n">B</span><span class="o">*</span><span class="n">CYB</span><span class="p">)</span> <span class="o">/</span> <span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">CSHIFT</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">U</span> <span class="o">=</span> <span class="p">(</span><span class="n">R</span><span class="o">*</span><span class="n">CUR</span> <span class="o">+</span> <span class="n">G</span><span class="o">*</span><span class="n">CUG</span> <span class="o">+</span> <span class="n">B</span><span class="o">*</span><span class="n">CUB</span><span class="p">)</span> <span class="o">/</span> <span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">CSHIFT</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">V</span> <span class="o">=</span> <span class="p">(</span><span class="n">R</span><span class="o">*</span><span class="n">CVR</span> <span class="o">+</span> <span class="n">G</span><span class="o">*</span><span class="n">CVG</span> <span class="o">+</span> <span class="n">B</span><span class="o">*</span><span class="n">CVB</span><span class="p">)</span> <span class="o">/</span> <span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">CSHIFT</span><span class="p">);</span>

  <span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">round</span><span class="p">(</span><span class="n">Y</span><span class="p">);</span>
  <span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">round</span><span class="p">(</span><span class="n">U</span> <span class="o">+</span> <span class="mi">128</span><span class="p">);</span>
  <span class="n">o</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">round</span><span class="p">(</span><span class="n">V</span> <span class="o">+</span> <span class="mi">128</span><span class="p">);</span>
<span class="cp">#endif</span>
</code></pre>
</div>
<p>這裏我把原版操作和修正版操作都寫在一起了，把 #if 1 改成 #if 0 即可切換。（爲什麼我要說這些= =）</p>
<p><strong>示例：左邊爲原版 Lena 醬，右邊均爲壓縮質量設置爲 80%，重複 30 次。</strong></p>
<p>完全 Skia 原版效果（即 Android 的）：8-bit 變換，移位除法，JDCT_IFAST 方法。</p>
<img class="content-image" src="http://pic3.zhimg.com/70/2b308422edc48a435f67bae3b0a069d2_b.jpg" alt="">
<p>畫質嚴重劣化，色彩偏綠。</p>
<p>不辣眼睛修正效果：8-bit 變換，移位除法，<strong>JDCT_FLOAT</strong> 方法。</p>
<img class="content-image" src="http://pic2.zhimg.com/70/1f6ee2471aa3f6105805102e6be8bed5_b.jpg" alt="">
<p>可以看到關閉 JDCT_IFAST 之後畫面細膩了。</p>
<p>繼續修復舍入漏洞的效果：8-bit 變換，<strong>正常舍入的除法</strong>，<strong>JDCT_FLOAT</strong> 方法。</p>
<img class="content-image" src="http://pic2.zhimg.com/70/33f75a87653da3d65145ab17e56b139d_b.jpg" alt="">
<p>可以看到色彩偏綠的問題被正確四捨五入修正了。</p>
<p>迴歸原版 libjpeg-turbo 的壓縮效果（現在的新版 Android）：<strong>16-bit</strong> 變換，<strong>正常舍入的除法</strong>，<strong>JDCT_FLOAT</strong> 方法。（其實原版是 JDCT_ISLOW，但差別不大）</p>
<img class="content-image" src="http://pic1.zhimg.com/70/59d5d1378de925f5049b892a9818aec0_b.jpg" alt="">
<p>比起 8-bit，少了很多&ldquo;色斑&rdquo;，因爲精度高了，色彩分辨率更高，或者說顏色的層次更加細膩。</p>
<p><strong>番外</strong></p>
<p>Q：爲什麼不用全身版 Lena&nbsp;做示例圖？</p>
<p>A：&hellip;&hellip;</p>
<p>（二營長，你他孃的意大利炮呢？！）</p>
<p><strong>來一個小的總結，給非專業的旁友們看：</strong></p>
<p><strong>圖片變綠是安卓系統一直以來的問題，直到 Android 7 才修復。原因是安卓系統內部的一個核心部件的代碼，爲了優化手機上運行的速度&mdash;&mdash;寫錯了 = =。</strong></p>
<p>2016.8.26, 21:54 發佈</p>
<p>2016.8.26, 22:32 修訂：修正表述錯誤，高亮</p>
<p>2016.8.26, 22:34 修訂：添加 S.B. 的網頁模擬工具地址</p>
<p>2016.8.26, 23:05 修訂：添加概要</p>
<p>2016.8.26, 23:56 修訂：同步示例代碼</p>
<p>2016.8.27, 00:38 修訂：調整令人困惑的表述</p>
<p>2016.8.27, 14:38 修訂：訂正錯字</p>
<p>2016.8.27, 23:29 修訂：明確闡述各修復步驟的變化</p>
<p>2016.8.27, 23:31 修訂：該死的我漏了句號</p>
</div>
</div>




</div>


</div>
</div>