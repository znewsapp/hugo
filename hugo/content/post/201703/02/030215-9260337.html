+++
date = "2017-03-02T15:00:00"
title = "亞馬遜雲計算服務出了點問題，北美互聯網哀鴻遍野"
titleimage = "http://pic2.zhimg.com/cc448f7a0fcd2c027683ede7ce49480d.jpg"
ga = 030215
+++

<div class="main-wrap content-wrap">
<div class="headline">

<div class="img-place-holder"></div>



</div>

<div class="content-inner">



<div class="question">
<h2 class="question-title"></h2>
<div class="answer">



<div class="content">
<p><strong>事件回顧</strong></p>
<p>美西太平洋時間早上 10 點（北京時間凌晨 2 點），AWS S3 開始出現異常。很多創業公司的技術人員發現他們的服務無法正常上傳或者下載文件。有人在 hacker news 上問：Is S3 down? 然後迅速得到大夥的確認。</p>
<p>然而，AWS 自己的 status page (<a class=" external" href="http://link.zhihu.com/?target=https%3A//status.aws.amazon.com" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">status.aws.amazon.com</span><span class="invisible"></span></a>) 卻後知後覺，放眼望去，一片讓人喜滋滋的綠油油。就在大夥兒以爲自己神經過敏，一切都是虛妄的猜測時，AWS 的工程師驚悚地發現，由於這個頁面依賴於 S3，所以它實際上也掛了，於是趕緊放了個 banner 上去說明狀況，然後在 twitter 上昭告天下綠油油是假象：</p>
<img class="content-image" src="https://pic4.zhimg.com/v2-38987936c23846c0f55b73fcab6c8067_b.jpg" alt="">
<p>11:35am，經過一番努力，這個頁面總算顯示正常的狀態了：</p>
<img class="content-image" src="https://pic1.zhimg.com/v2-89387fe9f8a94dfe8af031d407101bb8_b.jpg" alt="">
<p>可以看到，重災區是 North Virginia 的 S3。由於 S3 不工作，那些高度依賴 S3 的服務，比如 Elastic Map Reduce（需要 S3 存儲中間過程和結果），以及去年 re:invent 剛發佈的 Athena（查詢的數據要放在 S3 上），也完全掛掉。依賴 S3 不那麼重的服務，狀態也不是太好。</p>
<p>S3 是 AWS 最早發佈的雲服務，simple storage service，解決存儲的問題。存儲是任何互聯網服務的基石 &mdash;&mdash; 只要有大的數據對象，無論是圖片，視頻還是文本，我們都需要一個合適的存儲方案保存它們。在沒有云的日子裏，這些內容要麼存儲在無比昂貴的 SAN (Storage Area Network) 中，要麼存儲在大量 PC 服務器的磁盤陣列中，通過一些特殊的文件系統，如 HDFS 來訪問。爲了維護這些數據的持久性和可用性，互聯網公司需要在這樣的基礎設施上花費巨大的人力物力，無法集中所有的工程能力處理業務。當 S3 和類似 S3 的服務誕生後，對於很多初創的互聯網公司，簡直是久旱逢甘霖，99.99999% 的持久性（durability），和 99.99% 的可用性（availability）爽的不能再爽，於是紛紛把自個的存儲架構布在了 S3 上。時至今日，使用 S3 的網站，已經多達 148, 213 個（數據來自 techrunch）。</p>
<p>所以，當今早 S3（主要是 North Virginia）宕機時，整個北美的互聯網呈現一片哀魂遍野的景象。</p>
<p>Slack 無法上傳文件，進度條永遠在走：</p>
<img class="content-image" src="https://pic3.zhimg.com/v2-d8eb326d7bc273c9e88d4702cf1afdb6_b.jpg" alt="">
<p>Trello 表示老子都被收購了，休息，休息一會也無妨：</p>
<img class="content-image" src="https://pic2.zhimg.com/v2-126fe7ebfdd84f5a59007c89421e7651_b.jpg" alt="">
<p>收購了 Trello 的 Atlassian 也不遑多讓，文案好一本正經撲克臉（我都懷疑他們的工程師發現問題了麼）：</p>
<img class="content-image" src="https://pic3.zhimg.com/v2-10f40876356514d313587142df75f136_b.jpg" alt="">
<p>最近 VC 的寵兒 giffy，表面上一切正常（CDN 扛起了 gif 的下載），但如果你要上傳 gif，對不起，偶們也不知道發生了神馬事情：</p>
<img class="content-image" src="https://pic1.zhimg.com/v2-f4ea0e61562b88eff30c9dbe911dfa48_b.jpg" alt="">
<p>至於高冷的 quora，乾脆連個暖心的頁面都不給，直接說，老子不玩了：</p>
<img class="content-image" src="https://pic3.zhimg.com/v2-46bd78d13fba82c9ed6b3501bba22992_b.jpg" alt="">
<p>。。。</p>
<p>照理來說像 quora 這樣的服務，面向用戶閱讀的部分本不該高度依賴 S3，要掛也不該全站掛，頂多是掛用戶撰寫答案的部分，不知道爲何死的這麼徹底。</p>
<p>我們看看當問題出現時，一個普通的 S3 GET 返回什麼：</p>
<img class="content-image" src="https://pic1.zhimg.com/v2-bb1daf5259db7d0a9def6c65b02bd008_b.jpg" alt="">
<p>AWS 赤果果地告訴你，Internal Error 了。從 error handling 的角度，我們在寫代碼的時候都應該捕捉這個異常，然後做合適的錯誤處理。很遺憾的是，S3 這樣的服務是如此基礎，就像互聯網的水和電一樣，大家默認爲它永遠不會出錯。因此，好多工程師乾脆不做錯誤處理，像 slack 那樣，任由進度條一直傻乎乎地跑；或者，讓錯誤一路冒泡，直到把整個服務掛掉了事，像 quora / trello 那樣。這樣對用戶都不太友好。</p>
<p>Murphy 定律告訴我們，凡事可能發生，就將要發生。所以比較好的處理方法是，捕捉到異常，讓錯誤只侷限在特定的頁面，如：atlassian / giffy。或者，有個 plan B 應對突發事件。</p>
<p><strong>使用 S3 的用戶如何自救？</strong></p>
<p>類似的事情發生在任何公司上都是不幸的，尤其是給客戶以 SLA 保障的 SAAS 公司。大家能做得就是：</p>
<ul>
<li>當雲服務商的宕機發生時，儘量控制它影響面。像 trello 這樣連 landing page 都一併掛掉實在不可取，起碼 S3 影響不到的頁面，如 landing page，用戶註冊 / 登錄頁面，應該還保持正常服務；而像 quora 這樣的服務，其實是可以準備一個靜態化的鏡像，一旦出問題，起碼讓讀者可以無障礙地閱讀。</li>
<li>儘可能地把動態內容緩存起來，甚至靜態化。redis cache，nginx cache，HA proxy，CDN 都是把內容緩存甚至靜態化的一些手段。儘管多級緩存維護起來是個麻煩，但當底層服務出現問題時，它們就是難得的戰略緩衝區。cache 爲你爭取到的半個小時到幾個小時幾乎是續命的靈芝，它能幫你撐過最艱難的時刻（這次 S3 宕機前後大概 4 小時，最嚴重的時候是 11 點到 1 點），相對從容地尋找解決方案，緊急發佈新的頁面，或者遷移服務，把損失降到最低。否則，只能像這次事件中的諸多公司一樣，聽天由命，雙手合十祈禱 aws 的工程師給力些解決問題。</li>
<li>使用 simian army 在平日裏操練系統的容錯性。這個適合大一些的，工程團隊有餘力的公司。netflix 重度使用 aws，卻在歷次 aws 的宕機中毫髮無損，是因爲他們之前也深深地被雲的「不穩定性」刺痛過。他們的 chaos monkey（之後發展爲 simian army）服務，會隨時隨地模擬各種宕機情況，擾亂生產環境。比如說對於此次事件的演練，你可以配置 simian army 去擾亂 S3：simianarmy.chaos.fails3.enabled = true。這樣，這羣討厭的猴子就會在你不知情的情況下隨機把你的服務器的 /etc/hosts 改掉，讓所有的 S3 API 不可用。這樣你就可以體驗平時很難遇到的 S3 不可訪問的場景，進而找到相應的對策（注意：請在 staging 環境下謹慎嘗試，否則老闆把你開了不要賴程序君）。</li>
</ul>
<p>如果 AWS 真的發生大規模宕機，而你又沒有采取任何措施，天也不一定就塌下來了。此時此刻，你的投資人，你的客戶，你的合作伙伴也許都忙着解決他們各自的宕機問題呢，hacker news 上（<a class=" external" href="http://link.zhihu.com/?target=https%3A//news.ycombinator.com/item%3Fid%3D13755673" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">news.ycombinator.com/it</span><span class="invisible">em?id=13755673</span><span class="ellipsis"></span></a>）有個笑話這麼說：</p>
<blockquote>Why do we host on AWS?<br><br>Because if it goes down then our customers are so busy worried about themselves being down that they don't even notice that we're down!</blockquote>
<p>看，這就是 CIO / CTO 們的狡黠之處（自建的出了問題都得自己擦屁股）。</p>
<p><strong>如何利用這樣的宕機機會？</strong></p>
<p>Google 的工程師忙不迭地過來補刀加教育用戶：</p>
<img class="content-image" src="https://pic3.zhimg.com/v2-bf0cb653e0fdefd2fc7fa4ff64b2dfc2_b.jpg" alt="">
<p>你看，這個社會就是這麼羣狼環飼。你別說不努力了，你努力着，但只要摔上一跤，就有猛獸過來蹭肉吃。對於甲方來說，狼越多選擇越多，開心都來不及；作爲乙方，則欲哭無淚。這次事故，我們作爲乙方，看看熱鬧。但要知道，每家公司，甚至每個人，都在不同的上下文中扮演不同的角色，一會是甲方，一會是乙方。看熱鬧娃哈哈時，不要忘了有一天自己也可能遇到相同的境地，被自己的客戶放在火上烤。</p>
<p>什麼？你問 Tubi TV 宕沒宕機？雖然我們有我們操蛋的煩惱，但是託 CDN 的福，在過去的幾個小時，我們好好的。</p>



</div>
</div>
</div>


</div>
</div>