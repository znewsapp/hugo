+++
date = "2017-02-19T11:00:00"
title = "遊戲裏的這個金屬盔甲，怎麼看起來有點像塑料？"
titleimage = "http://pic3.zhimg.com/6e2c119f02aead53232693729d671ef6.jpg"
ga = 021911
+++

<div class="main-wrap content-wrap">
<div class="headline">

<div class="img-place-holder"></div>



</div>

<div class="content-inner">



<div class="question">
<h2 class="question-title">金屬，塑料，傻傻分不清楚</h2>
<div class="answer">



<div class="content">
<p>很多時候可以聽到遊戲玩家說，某某遊戲看起來什麼都是塑料做的。最近還聽一個設計師說，你用 Blinn-Phong 吧，那東西渲染出來就是濃濃的塑料感的。</p>
<p>金屬和塑料，區別在哪裏，真的是因爲 BRDF 模型嗎？</p>
<p><strong><strong>Diffuse/Specular</strong></strong></p>
<img class="content-image" src="https://zhihu.com/equation?tex=L_%7Bo%7D%28%5Cmathbf%7Bv%7D%29%3D%28%5Cmathbf%7Bc%7D_%7Bdiff%7D+%2B+%5Cfrac+%7B%5Calpha+%2B+2%7D+%7B8%7D%28%5Cmathbf%7Bn%7D+%5Ccdot+%5Cmathbf%7Bh%7D%29%5E%7B%5Calpha%7D+F%28%5Cmathbf%7Bc%7D_%7Bspec%7D%2C+%5Cmathbf%7Bl_c%7D%2C%5Cmathbf%7Bh%7D%29%29+%5Cotimes+%5Cmathbf%7Bc%7D_%7Blight%7D+%28%5Cmathbf%7Bn%7D+%5Ccdot+%5Cmathbf%7Bl_c%7D%29" alt="">
<p>那麼，是光滑度造成的嗎？不是。塑料也有粗糙和光滑，金屬也有粗糙和光滑。並不會因爲是金屬就不那麼粗糙。所以，現在的問題就是，什麼決定了材質的 diffuse 和 specular 顏色。</p>
<p>回到基於物理的 BRDF 這個出發點，看看從物理的角度，diffuse 和 specular 來自哪裏。</p>
<img class="content-image" src="https://pic2.zhimg.com/2a5eecfbb465f7c2f27fde774166772d_b.png" alt="">
<p>上圖來自於 Real-time Rendering 第三版。箭頭根據顏色可以分成幾種。簡化起見，就看最終出射的情況。深藍色和淺藍色表示 diffuse（分別來自於 single scattering 和 multiple scattering，但這不重要），金黃色表示 specular。原理上說，diffuse 是光線<strong>折射入物體後</strong>，在內部經過散射，重新穿出表面的光。而 specular 是光線在物體表面直接反射的結果。並沒有經過轉換，還是原來的光子。</p>
<p>（從這張圖還可以看出，因爲物體的密度和材料不同，diffuse 可能分佈到一個很廣的範圍內，不是一個點，而是一個光斑。specular 就是一個點。而且，這兩者位置上不重合。不過這已經超出了實時渲染甚至離線渲染的範疇，這裏不討論）</p>
<p>然而，對於金屬（導體）來說，折射入物體的光子會被完全吸收掉，就成了這個樣子：</p>
<img class="content-image" src="https://pic4.zhimg.com/82a53f7a3ccc9abd63e56da9daef8c0b_b.png" alt="">
<p>好了，這下明白了。對於金屬來說，diffuse 永遠是 0，材質的顏色來自於 specular。對於非金屬來說，材質的顏色一部分來自於 diffuse，一部分來自於 specular。</p>
<p><strong><strong>顏色分佈</strong></strong></p>
<p>既然如此，也就是說如果我們有能力控制 diffuse 和 specular 的顏色，就一定能在渲染上覆現出金屬（導體）和塑料（絕緣體）的區別，甚至介於其間的半導體。在此之前，先找一些現實中的材料，看看它們的 diffuse 和 specular 顏色分佈究竟如何。</p>
<p>這裏列舉一下來自<a class=" wrap external" href="https://link.zhihu.com/?target=http%3A//blog.selfshadow.com/publications/s2015-shading-course/hoffman/s2015_pbs_physics_math_slides.pdf" target="_blank" rel="nofollow noreferrer">Physics and Math of Shading</a>的幾張表。</p>
<img class="content-image" src="https://pic2.zhimg.com/1d06d0c7e0a4eb5ebcd3d9f3e983fbfd_b.png" alt="">
<p>第一張是金屬的 specular 顏色。前面說到金屬的 diffuse = 0，所以你看到的金屬顏色，就是它的 specular。從這張表可以看出，金屬的 specular 非常強烈，而且各通道都幾乎大於 0.5。唯一的例外是金，藍色通道較弱，而紅色通道已經超出了 sRGB 的表達範圍。（如此獨特的反射曲線，也是金子爲什麼有着獨特的文化和經濟地位的原因之一吧）</p>
<p>再來看看絕緣體陣營</p>
<img class="content-image" src="https://pic2.zhimg.com/1c49fc6c598ee6898cde7c77a9c54f91_b.png" alt="">
<p>同樣是 specular 顏色，非金屬則顯得弱了很多。塑料、玻璃、水這些常見的絕緣體，specular 都低於 0.04。而水晶、鑽石這些絕緣體， 你們知道爲什麼貴了吧。另一個特點是，絕緣體的 specular 都是單色的。各個通道的光都會被等同地反射，而不像金屬那樣有着不同的吸收偏好。</p>
<p>而半導體呢？如你所想，介於兩者之間。</p>
<img class="content-image" src="https://pic1.zhimg.com/d9aac6cd98e8a43fb523c114a66a4eac_b.png" alt="">
<p>有了這些信息，我們就可以進一步把它用於渲染了。</p>
<p><strong><strong>GBuffer</strong></strong></p>
<p>這幾年的渲染引擎，幾乎都是用的 deferred rendering 框架，其中一個兵家必爭之地就是 GBuffer。每年都有不同的文章在講如何把更多的信息擠到 GBuffer 中，正因爲 GBuffer 空間極其有限，而想放入的信息有越來越多。所以，如何利用信息之間的關係，把數據編碼到有限的空間裏，對 deferred rendering 來說非常重要。</p>
<p>如果按照前面的結論，需要放 diffuse 和 specular 顏色，則需要 6 個通道，完全超出了 GBuffer 可以承受的範圍。GBuffer 裏留給 diffuse 和 specular 顏色的通道只有 4 個。所以遊戲引擎常見的做法是，保存個 diffuse 顏色和 specular 的亮度。就當作 specular 是單色的來處理。這樣顯然對於金屬不利，也是爲什麼會畫面看着都像塑料的重要原因。</p>
<p>有了上一節的信息，直覺告訴我們一個想法，對於導體和絕緣體，應該分開用不同的保存方法。導體存 specular 顏色，因爲它的 diffuse 是 0。絕緣體存 diffuse，因爲 specular 非常弱，都用 0.04 這個常量表達就可以了。那麼半導體呢？就需要一個&ldquo;金屬性&rdquo;的係數，在兩者之間插值。</p>
<p>用公式來表達，就是</p>
<p>diffuse = albedo * (1 - metalness)</p>
<p>specular = lerp(0.04, albedo, metalness)</p>
<p>其中，albedo 就是 3 通道的反照率，metalness 就是金屬性係數。lerp 是線性插值的意思。這樣就用一個方法統一了導體、半導體、絕緣體的顏色分佈。metalness = 0 表示絕緣體，diffuse 就是 albedo，specualr = 0.04。metalness = 1 表示導體，diffuse = 0，specular = albedo。這麼一來，只要在 GBuffer 裏面存 albedo（3 通道）和 metalness（1 通道）。</p>
<p><strong><strong>結果和總結</strong></strong></p>
<p>這麼做的渲染結果如何呢？咱們來看看一組對比，用的是前面提到的基於物理的 Blinn-Phong，用的同樣的 albedo。</p>
<img class="content-image" src="https://pic3.zhimg.com/1a6458ed8bafe57c88f47cc80abe5586_b.jpg" alt="">
<p>粗糙的絕緣體</p>
<img class="content-image" src="https://pic1.zhimg.com/d9ac38167c7430b36146878287779234_b.jpg" alt="">
<p>光滑的絕緣體</p>
<img class="content-image" src="https://pic4.zhimg.com/067b9280596479026e46c9789bcfc17f_b.jpg" alt="">
<p>粗糙的導體</p>
<img class="content-image" src="https://pic3.zhimg.com/1771513b49d0f6f61d005c0accb155de_b.jpg" alt="">
<p>光滑的導體</p>
<p>從圖上還是很容易分辨那些是絕緣體那些是導體。而且很明顯可以看出，這件事情和光滑度無關，和 BRDF 模型也無關。</p>
<p>在來對比一下在引入 albedo+metalness 之前能達到的效果。</p>
<img class="content-image" src="https://pic3.zhimg.com/752d3ebc83bdd202d9e4b27f0a3a20aa_b.jpg" alt="">
<p>對比強烈吧，同樣的參數，原先的做法看起來就是油膩的塑料。</p>
<p>最後，來一組金屬性和粗糙度變化的陣列。</p>
<img class="content-image" src="https://pic2.zhimg.com/ca70bab601a9a2198903f382ffba25e5_b.jpg" alt="">
<p>我們用 albedo+metalness 的方法，在沒有增加存儲空間，和幾乎沒有增加計算開銷的情況下，實現了更高質量的金屬渲染。從此，只要做一些微小的工作，調調材質，就能避免塑料感。</p>
<p>在 KlayGE 裏面，GBuffer 的格式也已經改成這裏說的存儲方式，材質系統也做了相應的修改，以更好地表達這樣的材質分類。</p>
<p>在有些遊戲引擎，比如&nbsp;<a class=" wrap external" href="https://link.zhihu.com/?target=http%3A//www.slideshare.net/maciejjamrozik/deferred-rendering-in-dying-light" target="_blank" rel="nofollow noreferrer">Dying Light</a>，用了一個有點區別的編碼方式。那裏面只有導體和絕緣體兩種切分，沒有 metalness 的係數可以做過渡。這樣就可以把絕緣體的 specular 給編碼進去。又因爲絕緣體 specular 非常的小，只要佔用很少的位數。空出來的位可以把 translucent、皮膚、葉片等信息都編碼進去。但對導體絕緣體的分析和本文相同。</p>



</div>
</div>
</div>


</div>
</div>