+++
date = "2017-02-14T19:00:00"
title = "斷電的一瞬間，電腦硬盤裏會發生什麼？"
titleimage = "http://pic2.zhimg.com/a4c95941e32019b51bffc333d5e857b9.jpg"
ga = 021419
+++

<div class="main-wrap content-wrap">
<div class="headline">

<div class="img-place-holder"></div>



</div>

<div class="content-inner">




<div class="question">
<h2 class="question-title">硬盤寫到一半斷電時文件系統發生了什麼？</h2>

<div class="answer">



<div class="content">
<p>這事說起來挺複雜的，不同文件系統，不同設備，不同介質，效果都是有區別的。</p>
<p>斷電的一瞬間，很多事情是無法確定的：</p>
<p>1. 你無法確定你試圖向設備驅動發送的寫指令是否成功，<strong>驅動程序本身一般都有緩存</strong>；</p>
<p>2. 即使寫指令正常返回，你也無法確定設備實際上是否寫成功，因爲<strong>設備本身可能也有緩存</strong>。目前沒有設備能保證寫指令返回的情況下，<strong>所有數據一定成功</strong>的保存在介質上（但部分廠商能保證少量數據一定能成功寫入），對存儲設備的<strong>flush 操作並非絕對可靠</strong>；</p>
<p>3. 哪些成功哪些失敗<strong>可能是亂序的</strong>，換句話說，如果先發送寫請求 A，再發送寫請求 B，並且都成功返回，掉電時請求 A 可能丟失，但 B 成功（<strong>NCQ 功能</strong>）；</p>
<p>4. 機械式磁盤可能會出現丟失半截數據的情況（比如，一個 512 字節扇區只寫入了 100 字節，也就是題主說的 bit 級錯誤），但這種一般都會通過校驗位檢測出來。</p>
<p>因爲有以上這麼多的限制，實際上文件系統一般沒辦法保證數據一定不丟失，甚至哪些丟失哪些能恢復也是不確定的。</p>
<p>一般來說，文件系統有以下的幾種策略：</p>
<p>1. 完全不管錯誤的事情，錯了就錯了；</p>
<p>2. 打標記位的方式，如果懷疑有錯，通過磁盤檢測功能恢復；</p>
<p>3. 在設計上保證文件系統結構上可恢復，但不保證用戶數據可恢復；</p>
<p>4. 能在用戶數據層面上保證數據的絕對正確。</p>
<p>第一種和第二種策略現在比較少見，FAT 文件系統算是屬於這類；主流文件系統基本上都能保證第三種，比如 NTFS 之類的；第四種比較難，一般都要配合存儲驅動一起，多見於 Flash 介質的專屬文件系統。</p>
<p>保證數據不損壞，具體的方案一般有：</p>
<p><strong>方案 1：Copy-On-Write</strong>，寫數據的時候不在原來的位置寫，而是先讀一份，然後寫到另外一個位置，當確認寫成功時，把文件系統的指針指向新的位置。如下圖：</p>
<img class="content-image" src="http://pic3.zhimg.com/70/v2-7c6d9307ffcaa04805e4d6b469fb81aa_b.jpg" alt="">
<p>實際應用中，比這個情況複雜，因爲 Data2 寫入的過程中，File1 本身的一些信息（修改時間等）也發生了變化，所以 CopyOnWrite 產生的影響不止這一個塊，而是很多。</p>
<p><strong>方案 2：日誌（Journal）技術</strong>。使用日誌記錄 meta-data 甚至是數據塊的變化情況（NTFS 就是這種策略），一旦出現掉電情況，在日誌中反推到一個正確的狀態上，就可以保證 meta-data 不損壞。</p>
<p>常見的方案就這兩種，當然還有別的更復雜的技術，可以參考這個鏈接（<a href="https://en.wikipedia.org/wiki/Comparison_of_file_systems">Comparison of file systems</a>），但不管用什麼方案，本質上都是以犧牲性能爲代價換取結構上的穩定。</p>
<p>最後回到題主的問題，文件系統如何保證數據的正確性？如果是指文件的數據部分，是無法保證的，因爲文件系統無法確定數據到底寫沒寫進去，絕大多數文件系統只能保證自身結構是正確的，但這個正確可能是回滾之後的狀態，具體回滾多少內容，文件系統自己也不能保證。</p>
</div>
</div>




</div>


</div>
</div>