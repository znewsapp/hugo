+++
date = "2017-05-13T16:00:00"
title = "電腦勒索病毒全球爆發，我們能做什麼？"
titleimage = "https://pic4.zhimg.com/v2-1efcdb892c445e15f1a48f4112d0e447.jpg"
ga = 051316
+++

<div class="main-wrap content-wrap">
<div class="headline">

<div class="img-place-holder"></div>



<div class="headline-background">
<a class="headline-background-link" href="http://tech.qq.com/a/20170513/005824.htm">
<div class="heading">相關新聞</div>
<div class="heading-content">全球爆發電腦勒索病毒 已波及 99<br> 個國家</div>
<i class="icon-arrow-right"></i>
</a>
</div>

</div>

<div class="content-inner">




<div class="question">
<h2 class="question-title"></h2>

<div class="answer">



<div class="content">
<p>如果確實是由於 NSA 的 eternalblue（永恆之藍） 引起的，情況不會擴散太嚴重。但已感染的用戶會很鬧心。</p>
<p>1，個人寬帶 / 家庭用戶方面，運營商應該已經主動屏蔽了 445 端口；即使未屏蔽，一般家庭都在使用無線路由器，默認情況下不對公網開放 / 轉發任何端口，也可以避免被攻擊。</p>
<p>2，校園網方面，教育網雖然未主動屏蔽 445。但很多高校對師生個人計算機的 ip 地址的公網訪問採用白名單方式，也可以避免。 2.1，學校歷來是病毒的重災區，主客觀原因都有;想要解決起來問題也不少而且也不容易解決。</p>
<p>3，win10 用戶被微軟強制開啓自動更新了，應該已經更新 ms17-010 補丁了;但是校園網中存在了大量關閉了自動更新的 win7（或其他低版本 windows）用戶，可能會成爲重災區。</p>
<p>4，如果中招了，請做好丟失那些文件的準備。根據以往經驗，交錢並不能消災。文件應該是被 aes128 加密（後續版本有沒有用 aes256 不知道），在當前技術條件下，全球絕大多數人並沒有足夠的計算能力來對其進行暴力破解。想通過暴力破解來救回文件的可以死心了。</p>
<p>5，現在判斷該病毒僅通過主機主動掃描發動的攻擊，對於很多不開放公網權限的學校及單位還相對威脅不大。如果進一步的變種具備了蠕蟲特性，受感染的主機進一步掃描其局域網內設備並進行攻擊，可能受災面會進一步擴大。希望在這一天到來之前，大家都把補丁補齊了。</p>
<p>6，請（希望）所以看到這個回答的人儘快着手備份自己的重要文件，並養成異地多活備份的習慣。不要等數據丟了才意識到備份的重要性。</p>
<p>平時多備份，災時少流淚</p>
<p>這個漏洞（後門）是先被人曝光出來了，並且微軟已經及時發佈了補丁而且在還有 win10 強制自動更新這種有益 buff 加成情況下，依然造成了嚴重危害。</p>
<p>如果有類似的後門在戰時被精心策劃使用，其破壞力可能可以相當於在敵國首都扔了一顆大伊萬。雖然不一定能造成人員傷亡，但使該國的生活水平倒退到 20 世紀 90 年代不成問題。</p>
<p>補充：</p>
<p>微軟官方解決方案（不是殺毒）：<a href="https://technet.microsoft.com/zh-cn/library/security/MS17-010">Microsoft 安全公告 MS17-010 - 嚴重</a></p>
<p>其他預防方案：如果自己並不需要使用 smb 共享文件，可以考慮直接使用 windows 自帶防火牆主動屏蔽 445 端口來達到&ldquo;臨時解決&rdquo;的目的</p>
<p>不過其實對於已經中毒的用戶並沒有什麼實質性作用，毒可以清除了，數據還是回不來</p>
<p>Wcry 前世今生：<a href="https://www.pcrisk.com/removal-guides/10942-wcry-ransomware">Wcry Ransomware</a></p>
<p><strong>關於被加密資料無法被解密的原因：</strong></p>
<p>根據上文提及的<em>Wcry Ransomeware </em>中的說法，病毒採用 AES-128{什麼是 AES？&nbsp;<a href="http://www.mamicode.com/info-detail-514466.html">密碼算法詳解 --AES</a><a href="https://zh.wikipedia.org/wiki/%E9%AB%98%E7%BA%A7%E5%8A%A0%E5%AF%86%E6%A0%87%E5%87%86">https://zh.wikipedia.org/wiki/%E9%AB%98%E7%BA%A7%E5%8A%A0%E5%AF%86%E6%A0%87%E5%87%86</a>}</p>
<p>方式加密用戶數據，主密鑰長度爲 128bit=16Byte，約爲 0.016KB；病毒編寫者理智的做法是在每臺電腦上進行加密操作時，隨機生成個 128bit 的密鑰並對用戶數據進行加密，同時或等加密完成後，將該密鑰提交回自己的服務器並刪除受感染用戶計算機上的密鑰。一切處理妥當，彈出勒索界面，用戶終於知道了自己被感染了，然而已經晚了。</p>
<p>AES 的暴力破解是世界性難題，以 AES-128 爲例，其密鑰總個數爲 2 的 128 次方個，約爲 3.4&times;10 的 38 次方個，如果生成所有密鑰並存儲在一個文本文檔中，忽略換行等其他開銷，大概需要佔用 4.95&times;10 的 27 次方 TB。</p>
<p>病毒體本身不保存密鑰，無密鑰情況下暴力破解又是不可能完成的任務，利用 windows 的高危漏洞進行傳播，可以在用戶不進行任何操作的情況下感染，這大概就是這個勒索病毒最令人感到絕望的地方了。</p>
<p>還好，國內運營商反應夠快；還好，無線路由普及了（所以我要吐槽 IPv6 沒有 NAT6 了，把所有設備暴露在公網上，一旦出現類似情況必死無疑）；還好，微軟被人罵慘了的強制開啓 win10 的自動更新終於還是立大功了</p>
<p>在校園網又不想裝第三方殺毒的人（今後）能做什麼：開啓自動更新；開啓 Windows 自帶的防火牆；聯繫學校把所有師生的 IP 地址禁用公網訪問權限，僅開放白名單內的 IP（大誤，我會被打死的）；如果有可能，在電腦和校園網直接加一個路由器以避免個人電腦被直接暴露在公網上（我打賭，以後不會出現路由器和 Windows 操作系統同時爆出 0day，就算是同時爆 0day 了，現在路由器廠商 / 系統這麼多，我賭它不會出現所有路由器都被 0day）。</p>
<p>涉密不上網，上網不涉密，這是保證安全的最好途徑了</p>
<p>如果必須要聯網，安全就只能是相對的安全了。</p>
<p>再次補充：</p>
<p>如果懶得根據教程手動添加防火牆規則，或者不放心自己設置是否正確，可以使用如下方案：</p>
<p>以管理員模式運行 cmd 或 powershell，並依次執行以下兩條命令（Windows7 及以上，vista 沒測試，應該也行）</p>
<div class="highlight">
<pre><code class="language-text">netsh advfirewall set allprofile state on
netsh advfirewall firewall add rule name=deny445 dir=in action=block protocol=TCP localport=445
</code></pre>
</div>
<p>WindowsXP 直接在 cmd 窗口中運行（不保證一定有效）：</p>
<div class="highlight">
<pre><code class="language-text">netsh firewall set opmode enable
netsh firewall set portopening  protocol=TCP port=445 mode=disable name=deny445

net stop rdr
net stop srv
net stop netbt
</code></pre>
</div>
<p>第一條命令爲開啓防火牆（無論防火牆是否開啓都可以執行）</p>
<p>第二條命令爲添加一條 inbound 記錄，名字爲 band445，內容爲拒絕 445 端口的 tcp 連接</p>
</div>
</div>




</div>





<div class="question">
<h2 class="question-title"></h2>

<div class="answer">



<div class="content">
<p>看了卡巴斯基、麥咖啡的報告，覺得這個病毒至少有三個模塊，</p>
<p>感染模塊：使用 SMB 服務的 MS17-010 漏洞攻擊內網其它機器，獲取 System 權限，運行 shellcode 將病毒下載到 ProgramData 下隨機文件名目錄、Windows、System32（SysWOW64）目錄，釋放用於遠程控制的 tor（沒看到網橋列表，在國內可能根本連不上）。</p>
<p>分析報告中沒有提到除了此漏洞外的其他感染方式。</p>
<p>破壞模塊：運行一個批處理關閉卷影複製和系統還原（這個批處理是用當前用戶的 cmd，可能看到 UAC 提示），用 icacls 命令獲取全部文件的寫權限（這個不知道是用什麼權限執行的，求沒有 UAC 的賬戶的人證實），全盤查找各種有價值的文件（根據卡巴斯基的報告，有各種辦公類文檔、圖像文件和視頻文件、工程文件和源代碼、數據庫、SSL 密鑰文件、壓縮包、備份文件、虛擬機硬盤鏡像等）並對其進行加密，並顯示勒索窗口、勒索文字，修改壁紙，生成勒索文本文件。</p>
<p>生成 pky、eky 兩個文件，也許它們是解密的關鍵（解密應該需要使用到黑客的私鑰）</p>
<p>遠程控制模塊：通過 Tor 暗網裏的 C&amp;C 服務器發送用戶信息、接收指令。目前的報告還沒看到這個遠程控制模塊能做什麼，如果黑客還算守信，收到比特幣後可能會通過它來解密。但是這個勒索軟件釋放的文件中並不帶網橋列表，在國內很可能是連不上 Tor 網絡的。</p>
<p>我在想的是，它是如何從外網入侵到內網的呢？我猜測可能有幾種方式。</p>
<p>1、黑客使用了釣魚郵件 / 網頁掛馬等常見手段和另外一個下載者，先入侵內網中的一臺 Windows 機器。但是分析者並沒有捕捉到這個下載者的樣本。</p>
<p>2、這個蠕蟲不僅會掃描內網 IP 段，也會在公網上進行掃描。部分沒有防火牆並有漏洞的公網 Windows Server 服務器（這種情況下可能黑客會推遲破壞模塊的作用時間或者乾脆不發作，以防其網站或數據庫等掛掉而被提前發現）以及部分直連公網的普通用戶就會中招，然後如果這些機器同時還連有內網，就會導致內網機器中招。</p>
<p>3、黑客手動攻擊 Windows 服務器並安裝此蠕蟲。</p>
<p>這應該是歷史上第一個短時間內衝擊全球的帶有蠕蟲性質的勒索軟件，雖然看上去還是有點粗陋（不檢測虛擬機、釋放的文件太多），但是造成了重大破壞，打開了軍用級 0day 轉民用的新一頁。</p>
</div>
</div>




</div>


</div>
</div>