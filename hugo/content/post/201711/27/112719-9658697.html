+++
date = "2017-11-27T19:00:00"
title = "總覺得遊戲裏的虛化怪怪的，說不上是哪裏不自然"
titleimage = "https://pic4.zhimg.com/v2-19b2a08a73bc1b6c5086ef0369eecfeb.jpg"
ga = 112719
+++

<div class="main-wrap content-wrap">
<div class="headline">

<div class="img-place-holder"></div>



</div>

<div class="content-inner">




<div class="question">
<h2 class="question-title">爲什麼遊戲裏的鏡頭虛化「尤其是近景人物」總看起來不太自然？</h2>

<div class="answer">



<div class="content">
<p>多圖（9P）長文（將近兩千字）預警。爲了儘量避免過多的專業性內容，難免有些描述不盡準確之處，歡迎大佬指正和補充。</p>
<p>這一問題源於遊戲引擎實現虛化的具體方法，以我個人比較熟悉的虛幻 4 引擎爲例吧。</p>
<p>首先明確一點：所謂“虛化”是在模擬照相機拍攝照片時，景物處於鏡頭焦距之外而產生的成像模糊效果，在遊戲中用於營造類似電影的視覺感受，或者指定對焦物體來使玩家對特定物體集中注意力。這種效果在遊戲引擎中被稱爲“景深”(Depth of Field，簡稱 DoF)。</p>
<p>如上所述，<strong>景深是一種模擬攝像機鏡頭效果或者引導玩家注意力的工具，而不是用來模擬真實視覺效果的</strong>——人眼只能對視野中央的一小塊區域清晰成像，但是人眼變焦非常迅速，並且大腦中的視覺中樞會與眼睛互相配合進行圖像處理，這導致<strong>人實際上是不能看到景深的</strong>，正常人眼往什麼地方看都會迅速變焦到合適的狀態清晰成像（除非實在太靠近人眼，或者人眼有近視、遠視等生理障礙），於是“真實的”視覺效果中不存在景深模糊。</p>
<p>因此這裏所說的景深儘量自然，指的是景深效果儘量接近攝像機拍攝的焦距外物體的效果。</p>
<p>遊戲引擎想要獲得一個物體和攝像機之間的距離是很容易的，理論上只要按設定的焦距，對焦外物體施加一定量的模糊效果就能模擬出景深。這就是虛幻 4 最簡單的一種實現：高斯景深(Gaussian DoF)——得名於其所採用的高斯模糊方法。</p>
<img class="content-image" src="http://pic2.zhimg.com/70/v2-025b6f5dd2174ff3f85eef6615f4498d_b.jpg" alt="">
<p>然後是一種性能消耗相當大、但是更加接近真實鏡頭散焦效果的方法，稱爲散焦景深(Bokeh DoF)。</p>
<img class="content-image" src="http://pic4.zhimg.com/70/v2-daea759d7c70670c437c1badc87faf93_b.jpg" alt="">
<p>後來虛幻 4 還加入了一個名爲圓景深(Circle DoF)的東西，屬於一種性能優化的散焦景深，原理上類似，所以這裏就不多說它了。</p>
<p>觀察上面兩張圖，可以看出焦距外物體（特別是左側的近景物體）在高斯景深中是簡單地模糊成一片，而在散焦景深中（特別是高亮度的部分）則像是很多層層疊疊的多邊形光斑——後者顯然更接近一般的光學鏡頭散焦時拍出的效果，其“塗抹感”要弱一些。</p>
<p>但是這兩張圖中的虛化，都不同程度地在近距離時距離突變的位置（例如左側人形與身後陰影牆壁之間的邊緣）出現了不自然的“模糊區域的銳利感”，而遠距離（例如右側景物）則沒有這種現象。其原因來自虛幻 4 引擎判斷“應當給這個區域進行何種程度的模糊”時的方法：</p>
<img class="content-image" src="http://pic3.zhimg.com/70/v2-6824488dc565a16b9ee9320bd347043e_b.jpg" alt="">
<p>如圖，引擎依照每個像素點紋理和鏡頭的距離將其分爲五類：距離鏡頭非常近的近景（左側綠色區）、距離鏡頭非常遠的遠景（右側藍色區）、正好處於焦內的聚焦區（中間白色區），以及近 / 遠景和聚焦區之間的過渡區（綠 / 藍色到白色的漸變區）。在近景和遠景區，模糊程度都是最大，在聚焦區完全不模糊，而兩個過渡區的模糊程度則與聚焦區和近 / 遠景區之間線性過渡並連續。</p>
<p>引擎的分類結果如圖所示：</p>
<img class="content-image" src="http://pic1.zhimg.com/70/v2-5a7c241a04b1fe8c3de716d407a33bd8_b.jpg" alt="">
<p>上圖中綠色爲近景，藍色爲遠景，黑色爲聚焦區，漸變爲對應過渡區。引擎正是依靠這張圖的信息對場景進行模糊處理。</p>
<p>而真實的光學鏡頭拍攝的同時含有近景、焦距內景物和遠景的照片是這樣的：</p>
<img class="content-image" src="http://pic3.zhimg.com/70/v2-e8e650dab2b4c9c00db7f14323b19f16_b.jpg" alt="">
<p>如圖 5 所示，在真實的鏡頭散焦中，近景 - 焦距內景物的邊界（爲便於敘述稱爲 A 型邊界）和焦距內景物 - 遠景的邊界（B 型邊界）有明顯不同：由於 A 型邊界是近景（模糊）遮擋焦距內景物（清晰）產生的，而 B 型邊界是焦距內景物（清晰）遮擋遠景（模糊）產生的，因此 A 型邊界本身是模糊的，而 B 型邊界是清晰的。換句話說，<strong>如果近景遮擋了焦距內景物，那麼它們之間的邊界應當是模糊的；而如果焦距內景物遮擋了遠景，那麼它們之間的邊界應當是清晰的。</strong>圖 5 顯然可見這一現象：左側焦距內的植物葉片遮擋遠景形成了清晰的 B 型邊界，而右側近景植物葉片遮擋焦距內植物葉片，則形成了模糊的 A 型邊界。</p>
<p>我們現在來具體考察圖 1/2 中的左側區域，也就是人形腿部與身後牆壁之間模糊程度不自然的跳變。左側人形腿部與身後牆壁間（圖 4 中左側的綠色和黑色部分）形成了典型的 A 型邊界，即模糊的近景遮擋清晰的焦距內牆面，二者之間應當產生模糊的邊界。但是在圖 1 和圖 2 的實際渲染中，這個邊界是相當銳利的。由於圖 4 是依靠立體模型與攝像機的相對位置信息計算得出，用於標識近景的綠色人形與實際的人形圖像是完全一致的，綠色人形的邊緣就是場景中人形模型的邊緣。而引擎老老實實地依靠圖 3 中的方法對圖 4 中綠色人形區域進行了高度模糊，對黑色牆壁區域不做模糊。這就導致了“模糊”被限制在了綠色區域內，完全沒能和黑色的牆壁區域進行混合過渡，從而產生了不自然的銳利的 A 型邊界。</p>
<p>解決它的方法很簡單，虛幻 4 的景深系統提供了現成的 Occlusion（封閉）屬性，用於定義模糊形體的半透明輪廓“泄露”出原本輪廓的程度。適當調整該屬性就能得到效果很不錯的 A 型邊界：</p>
<img class="content-image" src="http://pic1.zhimg.com/70/v2-5ce1383c04f592da4a289edf49c49c44_b.jpg" alt="">
<img class="content-image" src="http://pic2.zhimg.com/70/v2-4e3cd8f5406cf7bf86dd28b93a748d39_b.jpg" alt="">
<img class="content-image" src="http://pic3.zhimg.com/70/v2-9fe21b320788728e83b0e3e522106342_b.jpg" alt="">
<p>不過很多遊戲中確實仍然存在明顯不協調的銳利的 A 型邊界，例如巫師 2 在打開“電影景深”選項以後就是重災區：</p>
<img class="content-image" src="http://pic1.zhimg.com/70/v2-12c892dabcc90ca9e71d86a27e075b44_b.jpg" alt="">
<p>或許不這麼做是出於性能方面的考慮，畢竟多一步處理步驟就要多花一點時間，而遊戲渲染一幀的時間能多壓榨出一毫秒，幀率就會有顯著提高；也或許是出於“景深就是用來讓玩家注視清晰的聚焦部分的，非聚焦區域質量差點沒關係”的實用性考慮。</p>
<p>參考資料：<a href="https://docs.unrealengine.com/latest/INT/Engine/Rendering/PostProcessEffects/DepthOfField/index.html">Depth of Field</a></p>
</div>
</div>




</div>


</div>
</div><script type="“text/javascript”">window.daily=true</script>