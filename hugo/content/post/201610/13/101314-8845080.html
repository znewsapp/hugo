+++
date = "2016-10-13T14:00:00"
title = "路由器出 bug，還真的可能是宇宙射線的影響"
titleimage = "http://pic2.zhimg.com/a00cfa88e15a3595057dd2a3b162fce1.jpg"
ga = 101314
+++

<div class="main-wrap content-wrap">
<div class="headline">

<div class="img-place-holder"></div>



<div class="headline-background">
<a class="headline-background-link" href="http://www.cnbeta.com/articles/542679.htm">
<div class="heading">相關新聞</div>
<div class="heading-content">思科稱可能是宇宙射線觸發了路由器 bug</div>
<i class="icon-arrow-right"></i>
</a>
</div>

</div>

<div class="content-inner">




<div class="question">
<h2 class="question-title">宇宙射線對計算機訊號傳遞的錯誤率有多大影響？</h2>

<div class="answer">



<div class="content">
<p>有謬誤歡迎指正，非核工程專業。</p>
<p>非常大。</p>
<p>電路是靠着電容上積累的電荷確定 0 或者 1 的。</p>
<p>任何形式的輻射， 都會傷害無保護的 ASIC 電路。 方式多種多樣， 最終目的無非一個： 以電離， 撞擊等方式， 導致 Soft Error（軟錯誤，也即可以糾正的，不影響硬件本身的錯誤），其中 single event effect（SEE， 單事件錯誤）是這裏面主要的參量 。嚴重的，甚至會導致硬件本身損壞 （Hard Error），也即不可修復的錯誤。這一點放到後面講.</p>
<p>也就是說，我往內存裏存了個數，二進制 0000 1111； 結果粒子一打過來，喲呵～ 變成 0001 0111 了。</p>
<p>如果是數學運算&hellip;&hellip;加減法做不對會導致計算軌道錯誤啊之類的；如果是控制位&hellip;&hellip;你最好保證反轉的那兩個比特沒有控制什麼飛船彈射之類的參數。 不然本來輸入 0 不要彈射， 一反轉變成 1 趕緊彈射。玩兒脫了&hellip;&hellip;</p>
<p>比如說切爾諾貝利事件之後，蘇聯令人髮指的召集志願者去清理輻射，原因是<strong>機器人進去就不聽使喚了。更嚴重的是，這些機器人拿出來以後，也不能使用了。</strong></p>
<p>那麼怎麼知道我這個電路會不會這樣呢？ 標準方法叫做 SEE testing， 單次事件測試。</p>
<p>這個測試簡單粗暴： 用一束已知能量的粒子去轟擊測試芯片， 同時進行外部操作， 看最終結果會不會翻轉。這一束粒子可以是任何粒子，包括 alpha 射線，beta 射線，中字束，混合各種各樣的粒子等等。粒子束的強度統一以入射粒子的能量，linear energy transfer， LET 來記。具體到數量級上的話， 如果是目前普通的家用計算機，大概電離輻射量 在 0.x keV cm2 /mg 就掛了。 （掛了=出現了軟件諸如 ECC 無法修復的錯誤）</p>
<p>* 對於伽馬射線，LET 的計算方式不太一樣，因爲這貨是光子; 計算的時候一般是算由伽馬射線引發的電子束強度.</p>
<p>太空的標準參考 LET 是 60-120 MeV cm2 /mg</p>
<p>垮了噻&hellip; 差了幾個數量級啊！</p>
<p>原因是家裏面的電腦由於地球母親磁場和大氣層的保護， 基本不會受到轟擊。 設計的時候， 設計師們都表示呵呵呵呵誰要管你。</p>
<p>太空工程師表示&hellip;&hellip;我們怎麼辦&hellip;&hellip;</p>
<p>說一下 LET 是如何用來測量的: 一般來說，用一束粒子轟擊這個芯片，如果這個轟擊有效 （改變了某些元器件電容上的電荷），那麼這個芯片上會向外射出粒子.</p>
<p>LET，顧名思義，線性 能量 轉移，就指的是在這個有效轟擊裏，有多少能量被轉移出來了.</p>
<p>LET_thresh，是對於一個器件來說，不斷地給它施加高能粒子束，高到某一個能級的時候，飛出來的粒子能量不再提升了.</p>
<p>那麼一般來說，家用機 LET_thresh 非常低，表現形式就是稍稍拿粒子轟擊一下，就會飛出來一堆電子; 但是如果我逐步加大這個粒子束的強度，出來的電子不會變多!</p>
<p>什麼意思呢? 就是說: 家用機無論你怎麼轟擊，就只能出來這麼多電子了。再多的電子在原子內層，你轟不出來.</p>
<p>爲什麼這是一個壞事呢? 半導體裏面可用的電子密度就那麼點點，結果一點點粒子束就全把它轟出來了剩下的原子核和內層電子等着結婚咩...</p>
<p>所以說，環境裏面的 LET 越高，說明<strong>這個環境有能力轟出更多的電子; </strong>而<strong>器件的 LET_thresh 越高，說明這個器件能承受被轟出更多的電子，也即在高輻射下更加穩定。</strong></p>
<p>在 CMOS 出生的同時， 太空 / 核 工程師們就找到了一種能讓標準 CMOS 承受高輻射的方法：</p>
<p>把 CMOS 設計成這樣：</p>
<img class="content-image" src="http://pic2.zhimg.com/70/b39bf293e4ab1c768166102700e050b5_b.jpg" alt="">
<p>這叫做 enclosed layout transistor。 很噁心吧！ 這玩意兒的 長寬比不再可以簡單的算出來了， 而是要用一套複雜的公式計算。</p>
<p>這樣可以把微米級別的電子芯片做到幾十 MeV cm2/ mg。看起來不錯哦～</p>
<p>（該技術依然廣泛應用於目前的航天 / 高能物理場所）。</p>
<p>但是！ 地上的工程師們呵呵一笑： 我們的 sub-micron technology 要不要？ 要不要？ 不要的話我們就繼續奔向納米級別了，你們微米級別慢慢玩。</p>
<p>太空工程師一計算， 0.25um 的 CMOS 只能承受 大概 15MeV cm2 / mg&hellip; 表示不開心。</p>
<p>然後， 在 CERN 製作 LHC 的時候， 又繼續發揚光大， 縮小器件的同時，加入了 harden mode（也即在上面那個 ELT 的基礎上在外圈再加入一圈兇殘的 guardring，這樣可以抵禦相對強烈的粒子束轟擊）。</p>
<p>然後就做到了 89MeV cm2 / mg， 反正 CERN 表示我們的 LHC 夠用了。</p>
<p>記得太空裏是 60-120 MeV cm2 /mg 吧&hellip; 太空工程師欲哭無淚&hellip; 你們做這個纔剛剛達標啊！</p>
<p>（原話：那沒辦法啦&hellip; 硬件差不多到頭了&hellip;剩下的只能靠軟件了&hellip;）</p>
<p>改爲: 電路方法克服這些錯誤基本到頭了，剩下的靠屏蔽 + 架構來解決。</p>
<p>克服 Soft Error 有兩個無堅不摧的法寶: 把電路做大或者頻率減低。但是這兩個都會拖慢計算機的效率。</p>
<p>架構上的方式，基本可以總結爲：加冗餘，交織設計，和家用機裏也會有的 ECC（Error Correct Code）。當然這裏的 ECC 會不同。（感謝@<a href="http://www.zhihu.com/people/tai-chu-you-wei">太初有爲</a>的指正！）</p>
<p>加冗餘就是把本來一個電路能完成的份額用三個或者更多個（奇數個）電路做，做出來之後取多數答案當做正確答案。假設本來某個粒子有 50% 的可能會翻轉一個比特，三份冗餘之後，就只有 50% * 50%= 25% 的概率了。另外，據@<a href="http://www.zhihu.com/people/tai-chu-you-wei">太初有爲</a>說以及查證，標準的三份冗餘會使用不同的時鐘等，這樣更是降低了一個粒子干擾一片電路的可能性。</p>
<p>交織設計在@<a href="http://www.zhihu.com/people/tai-chu-you-wei">太初有爲</a>的答案裏有詳細的介紹。不再贅述。</p>
<p>（具體參考文獻可點擊「查看知乎討論」獲取。）</p>
</div>
</div>

<div class="answer">



<div class="content">
<p>所謂的宇宙射線，也叫空間輻照，主要對 CMOS 體硅工藝的器件會有比較大的影響。</p>
<p>很不幸地，我們大部分的計算機芯片都屬於這個範疇。</p>
<p>空間輻照主要考慮有這樣幾個影響：總劑量效應和單粒子效應。總劑量效應是一個類似電子遷移一樣的累積過程，比如會造成一個反相器的翻轉電壓降低，最後不能工作。這個效應在地球上基本不必考慮，一是因爲到達地球大氣層的高能粒子數量較少，第二大部分電子器件的壽命沒有設計的過長。但是在空間就不一定了，在空間環境里長期的粒子能量積累，最終會造成器件的損傷。總劑量效應的度量單位是拉德（材料），一般按照 nasa 的要求，近地軌道要求在器件生命週期內能抗 200k 拉德（硅）的輻照量，而深空環境裏面，一般都是要求抗 1M 拉德（硅）以上的總輻照劑量。那麼在地球上，其實不必特別考慮總劑量的影響。</p>
<p>其次是單粒子效應。單粒子效應就是指一個高能粒子打穿 CMOS 的某些敏感區域，造成器件的失效。這種失效有硬失效有軟失效。硬失效就是器件損傷了。一般這種硬失效表現爲閂鎖。閂鎖的現象就是器件電流突然增大，最終被燒燬。閂鎖就是 CMOS 中襯底和阱之間的 pnpn 結被導通，最終形成一個正反饋迴路。閂鎖在地面也會發生，但不一定是高能粒子造成的，也有可能是相鄰兩個 cell 靠的比較近產生互感。這個一般芯片設計商在設計的時候都會考慮這個效應，但是不會細緻到考慮高能粒子擊穿器件那個地步，所以閂鎖在地面會發生，但機率不大，即使發生了也不一定會燒燬器件（閂鎖在某些條件下是可以退出的），屬於小概率事件。然後，單粒子效應還會造成軟失效，就是所謂單粒子翻轉或單粒子脈衝。</p>
<p>單粒子脈衝的發生也是需要高能粒子打在 cmos 器件上，然後形成一個毛刺，這個毛刺如果運氣好，可以被下一級的 DFF 吸收掉，運氣不好，正打在 DFF 的建立保持時間窗內，寄存器就翻轉了。最可怕的是打在時鐘樹的根節點上，那就會造成大面積的寄存器錯誤翻轉。即使被打中，這個會不會造成 bug 也是個概率問題，假設打中了某個通用寄存器，但是這個寄存器可能不會被使用，或下一拍就被刷新了，那就和沒打中一樣。除了單粒子脈衝，還有單粒子翻轉，這個發生的粒子能量閾值條件是最低的，因此是軟失效中最常見的現象。這種軟失效不一定會由宇宙射線造成，在地球上發生的機率也很大。</p>
<p>記得很久以前，某次太陽黑子爆發，某廠家的服務器的 CPU 因爲沒有做軟失效加固，造成大面積失效，丟失大量市場份額。在這方面現在做的最好的是 SUN，他家的服務器以穩定著稱，但是當我知道他們的 CPU 做的加固手段之全面，也還是被折服了。一般來講所有的軟失效的發生是個概率事件，發生了會不會造成 bug 也是個概率事件，造成了 bug 你會不會觀察到，又是個概率事件，觀察到了對主功能會不會造成影響還是個概率事件。</p>
<p>針對軟失效，芯片廠家會在硬件上進行加固，所謂的加固，一般來說就是增加校驗，你看很多服務器的內存都是帶 ECC 的，這種校驗一般可以糾正一位錯誤，檢查到兩位錯誤。還有一個就是在內存上進行交織設計，就是讓一個 word 的 bit 儘量分散在不同區域，不要一個粒子打中後一下錯一片。所有不重要的寄存器做 parity，重要的做 ecc，反正就是能想到的全給你加上。</p>
<p>抗單粒子軟失效還有一個手段就是換材料和工藝，比如在硅上再生長一層，被稱爲外延增長技術的硅片，或者乾脆換成絕緣體上硅材料，這個是 IBM 研發的，AMD 曾經有幾條產線，以前所有的 powerpc 都是基於這個材料工藝的。這個工藝的初衷是降功耗和麪積，後來還發現他有個抗單粒子效應的自帶屬性，後來就被美國軍方關注了，再後來因爲這個工藝成本還是比較大，逐漸就被商業棄用了。</p>
<p>所以總體上來講，宇宙射線對 bug 還是有一定的影響的，但取決於你的可靠性要求。在某一個閾值上任何增加可靠性的設計都是昂貴的，軟失效設計是一門系統工程，如果只是想簡單防一下，其實採用高等級的服務器，多加校驗方式，還是提升比較明顯的。</p>
</div>
</div>




</div>


</div>
</div>